# 第一阶段开发说明文档

## 📋 文档概述

本文档为第一阶段开发任务提供详细的技术实现说明，包括数据结构设计、组件架构、状态管理、API接口等技术细节。

## 🏗️ 系统架构

### 整体架构
```
┌─────────────────────────────────────────────────────────┐
│                     前端应用 (React)                      │
├─────────────────────────────────────────────────────────┤
│                   状态管理层 (Redux/Zustand)              │
├─────────────────────────────────────────────────────────┤
│                     服务层 (Services)                     │
├─────────────────────────────────────────────────────────┤
│                   数据持久化 (LocalStorage)              │
└─────────────────────────────────────────────────────────┘
```

### 模块划分
```
src/
├── components/          # UI组件
│   ├── common/         # 通用组件
│   ├── production/     # 生产模块组件
│   ├── facilities/     # 设施模块组件
│   └── technology/     # 科技模块组件
├── services/           # 业务逻辑服务
├── store/             # 状态管理
├── types/             # TypeScript类型定义
├── utils/             # 工具函数
└── data/              # 游戏数据配置
```

## 📊 数据结构设计

### 1. 物品系统

```typescript
// 物品基础接口
interface Item {
  id: string;                    // 唯一标识
  name: string;                  // 物品名称
  category: ItemCategory;        // 物品分类
  icon: string;                  // 图标路径
  stackSize: number;             // 堆叠上限
  unlocked: boolean;             // 是否已解锁
  unlockRequirement?: string[];  // 解锁条件（科技ID列表）
  description: string;           // 物品描述
}

// 物品分类枚举
enum ItemCategory {
  RAW_MATERIAL = 'raw_material',      // 原材料
  INTERMEDIATE = 'intermediate',      // 中间产品
  FINISHED = 'finished',              // 成品
  CONSUMABLE = 'consumable'           // 消耗品
}

// 物品库存
interface ItemInventory {
  itemId: string;
  quantity: number;
  lastUpdated: number;  // 时间戳
}

// 生产配方
interface Recipe {
  id: string;
  outputItemId: string;
  outputQuantity: number;
  inputs: RecipeInput[];
  craftingTime: number;        // 秒
  craftingMachine: string[];    // 可用的生产设施ID
  energyRequired: number;       // 所需电力 (kW)
  unlocked: boolean;
}

interface RecipeInput {
  itemId: string;
  quantity: number;
}
```

### 2. 设施系统

```typescript
// 设施基础接口
interface Facility {
  id: string;
  name: string;
  type: FacilityType;
  category: FacilityCategory;
  icon: string;
  maxStackSize: number;         // 最大建造数量
  unlocked: boolean;
  unlockRequirement?: string[];  // 解锁条件
}

// 设施类型
enum FacilityType {
  POWER_GENERATOR = 'power_generator',   // 发电设施
  RESOURCE_EXTRACTOR = 'extractor',      // 资源采集
  PRODUCTION = 'production',             // 生产设施
  RESEARCH = 'research'                  // 研究设施
}

// 设施分类（用于UI显示）
enum FacilityCategory {
  POWER = 'power',              // 电力相关
  MINING = 'mining',            // 采矿
  SMELTING = 'smelting',        // 冶炼
  CRAFTING = 'crafting',        // 制造
  CHEMICAL = 'chemical',        // 化工
  RESEARCH_LAB = 'research'     // 研究
}

// 设施实例（玩家建造的设施）
interface FacilityInstance {
  id: string;                   // 实例ID
  facilityId: string;           // 设施类型ID
  count: number;                // 数量
  status: FacilityStatus;       // 运行状态
  efficiency: number;           // 效率 (0-100)
  powerConsumption?: number;    // 电力消耗 (kW)
  powerGeneration?: number;     // 电力产出 (kW)
  production?: ProductionData;  // 生产数据
}

enum FacilityStatus {
  RUNNING = 'running',
  STOPPED = 'stopped',
  NO_POWER = 'no_power',
  NO_RESOURCE = 'no_resource',
  OUTPUT_FULL = 'output_full'
}

interface ProductionData {
  currentRecipeId?: string;
  progress: number;           // 0-100
  inputBuffer: ItemStack[];   // 输入缓冲区
  outputBuffer: ItemStack[];  // 输出缓冲区
}

interface ItemStack {
  itemId: string;
  quantity: number;
}
```

### 3. 科技系统

```typescript
// 科技定义
interface Technology {
  id: string;
  name: string;
  icon: string;
  category: TechCategory;
  tier: number;                    // 科技等级
  prerequisites: string[];         // 前置科技ID
  cost: TechCost[];               // 研究成本
  researchTime: number;            // 研究时间（秒）
  effects: TechEffect[];           // 解锁效果
  unlocked: boolean;               // 是否已解锁
  researching: boolean;            // 是否正在研究
  progress: number;                // 研究进度 (0-100)
}

// 科技分类
enum TechCategory {
  AUTOMATION = 'automation',       // 自动化
  LOGISTICS = 'logistics',         // 物流
  MILITARY = 'military',           // 军事
  PRODUCTION = 'production',       // 生产
  ENERGY = 'energy',              // 能源
  RESEARCH = 'research'           // 研究
}

// 科技成本（科技瓶）
interface TechCost {
  sciencePackType: SciencePackType;
  quantity: number;
}

enum SciencePackType {
  RED = 'red',          // 红色科技瓶（基础）
  GREEN = 'green',      // 绿色科技瓶（军事）
  BLUE = 'blue',        // 蓝色科技瓶（化工）
  PURPLE = 'purple',    // 紫色科技瓶（生产）
  YELLOW = 'yellow',    // 黄色科技瓶（效能）
  WHITE = 'white'       // 白色科技瓶（太空）
}

// 科技效果
interface TechEffect {
  type: TechEffectType;
  targets: string[];    // 目标ID列表
  value?: number;       // 效果数值
}

enum TechEffectType {
  UNLOCK_RECIPE = 'unlock_recipe',
  UNLOCK_ITEM = 'unlock_item',
  UNLOCK_FACILITY = 'unlock_facility',
  INCREASE_SPEED = 'increase_speed',
  INCREASE_EFFICIENCY = 'increase_efficiency',
  REDUCE_COST = 'reduce_cost'
}

// 研究队列
interface ResearchQueue {
  queue: string[];              // 科技ID队列
  currentResearch?: string;     // 当前研究的科技ID
  lastUpdateTime: number;       // 上次更新时间戳
}
```

### 4. 电力系统

```typescript
// 电力网络状态
interface PowerGrid {
  totalGeneration: number;      // 总发电量 (kW)
  totalConsumption: number;     // 总消耗量 (kW)
  efficiency: number;           // 电网效率 (0-100)
  generators: PowerGenerator[]; // 发电机列表
  consumers: PowerConsumer[];   // 用电设备列表
}

interface PowerGenerator {
  facilityInstanceId: string;
  type: string;                 // 发电机类型
  maxOutput: number;            // 最大输出 (kW)
  currentOutput: number;        // 当前输出 (kW)
  fuelType?: string;           // 燃料类型
  fuelConsumption?: number;    // 燃料消耗率
}

interface PowerConsumer {
  facilityInstanceId: string;
  type: string;
  powerDemand: number;         // 电力需求 (kW)
  powerReceived: number;       // 实际获得电力 (kW)
  priority: number;            // 优先级 (1-10)
}
```

## 🎮 游戏状态管理

### 全局游戏状态

```typescript
interface GameState {
  // 玩家数据
  player: PlayerState;
  
  // 物品库存
  inventory: Map<string, ItemInventory>;
  
  // 设施实例
  facilities: Map<string, FacilityInstance>;
  
  // 科技状态
  technologies: Map<string, Technology>;
  researchQueue: ResearchQueue;
  
  // 电力系统
  powerGrid: PowerGrid;
  
  // 游戏统计
  statistics: GameStatistics;
  
  // 游戏设置
  settings: GameSettings;
}

interface PlayerState {
  id: string;
  name: string;
  playTime: number;              // 游戏时间（秒）
  lastSaveTime: number;          // 上次保存时间
}

interface GameStatistics {
  totalItemsProduced: Map<string, number>;
  totalPowerGenerated: number;
  totalResearchCompleted: number;
  achievementsUnlocked: string[];
}

interface GameSettings {
  autoSave: boolean;
  autoSaveInterval: number;      // 分钟
  difficulty: DifficultyLevel;
  soundEnabled: boolean;
  notificationsEnabled: boolean;
}

enum DifficultyLevel {
  EASY = 'easy',
  NORMAL = 'normal',
  HARD = 'hard'
}
```

## 🔧 核心服务设计

### 1. 物品服务 (ItemService)

```typescript
class ItemService {
  // 获取所有物品
  getAllItems(): Item[];
  
  // 获取已解锁物品
  getUnlockedItems(): Item[];
  
  // 按分类获取物品
  getItemsByCategory(category: ItemCategory): Item[];
  
  // 获取物品详情
  getItemDetails(itemId: string): ItemDetails;
  
  // 检查物品是否解锁
  isItemUnlocked(itemId: string): boolean;
  
  // 获取物品配方
  getRecipesForItem(itemId: string): Recipe[];
  
  // 获取使用该物品的配方
  getRecipesUsingItem(itemId: string): Recipe[];
}

interface ItemDetails {
  item: Item;
  inventory: ItemInventory;
  recipes: Recipe[];
  usedInRecipes: Recipe[];
  productionRate: number;        // 生产速率
  consumptionRate: number;       // 消耗速率
}
```

### 2. 设施服务 (FacilityService)

```typescript
class FacilityService {
  // 获取所有设施类型
  getAllFacilities(): Facility[];
  
  // 获取特殊设施（产物不在物品列表中）
  getSpecialFacilities(): Facility[];
  
  // 创建设施实例
  createFacility(facilityId: string, count: number): FacilityInstance;
  
  // 更新设施状态
  updateFacilityStatus(instanceId: string): void;
  
  // 计算设施效率
  calculateEfficiency(instance: FacilityInstance): number;
  
  // 获取设施生产数据
  getProductionData(instanceId: string): ProductionData;
  
  // 设置生产配方
  setRecipe(instanceId: string, recipeId: string): boolean;
}
```

### 3. 科技服务 (TechnologyService)

```typescript
class TechnologyService {
  // 获取科技树数据
  getTechTree(): TechTreeNode[];
  
  // 获取可研究的科技
  getAvailableTechnologies(): Technology[];
  
  // 开始研究
  startResearch(techId: string): boolean;
  
  // 添加到研究队列
  addToQueue(techId: string): boolean;
  
  // 更新研究进度
  updateResearchProgress(): void;
  
  // 完成研究
  completeResearch(techId: string): void;
  
  // 应用科技效果
  applyTechEffects(effects: TechEffect[]): void;
  
  // 获取研究队列
  getResearchQueue(): ResearchQueue;
  
  // 调整研究队列顺序
  reorderQueue(newOrder: string[]): void;
}

interface TechTreeNode {
  technology: Technology;
  children: TechTreeNode[];
  position: { x: number; y: number };  // 用于UI布局
}
```

### 4. 电力服务 (PowerService)

```typescript
class PowerService {
  // 获取电力系统状态
  getPowerGridState(): PowerGrid;
  
  // 添加发电设施
  addGenerator(facility: FacilityInstance): void;
  
  // 添加用电设施
  addConsumer(facility: FacilityInstance): void;
  
  // 更新电力分配
  updatePowerDistribution(): void;
  
  // 计算电网效率
  calculateGridEfficiency(): number;
  
  // 获取电力统计
  getPowerStatistics(): PowerStatistics;
  
  // 检查电力平衡
  checkPowerBalance(): PowerBalance;
}

interface PowerStatistics {
  totalGeneration: number;
  totalConsumption: number;
  generationByType: Map<string, number>;
  consumptionByType: Map<string, number>;
  historicalData: PowerHistoryPoint[];
}

interface PowerBalance {
  isBalanced: boolean;
  surplus: number;              // 剩余电力
  deficit: number;              // 缺口电力
  recommendations: string[];    // 建议
}
```

## 🖼️ UI组件设计

### 1. 生产模块组件

```typescript
// 物品网格组件
interface ItemGridProps {
  items: Item[];
  category?: ItemCategory;
  onItemClick: (item: Item) => void;
  showQuantity?: boolean;
}

// 物品详情对话框
interface ItemDetailDialogProps {
  item: Item;
  open: boolean;
  onClose: () => void;
  onCraft?: (recipeId: string) => void;
}

// 分类标签组件
interface CategoryTabsProps {
  categories: ItemCategory[];
  selected: ItemCategory;
  onChange: (category: ItemCategory) => void;
  counts?: Map<ItemCategory, number>;  // 各分类物品数量
}
```

### 2. 设施模块组件

```typescript
// 设施列表组件
interface FacilityListProps {
  facilities: FacilityInstance[];
  onFacilityClick: (facility: FacilityInstance) => void;
  onQuantityChange: (id: string, delta: number) => void;
  groupBy?: 'type' | 'status' | 'product';
}

// 电力管理面板
interface PowerManagementPanelProps {
  powerGrid: PowerGrid;
  onAddGenerator: (type: string) => void;
  onOptimize: () => void;
}

// 设施状态卡片
interface FacilityStatusCardProps {
  facility: FacilityInstance;
  showDetails?: boolean;
  onConfigure?: () => void;
}
```

### 3. 科技模块组件

```typescript
// 科技树可视化组件
interface TechTreeVisualizerProps {
  techTree: TechTreeNode[];
  onTechClick: (tech: Technology) => void;
  highlightPath?: string[];  // 高亮路径
}

// 研究队列组件
interface ResearchQueueProps {
  queue: ResearchQueue;
  onReorder: (newOrder: string[]) => void;
  onRemove: (techId: string) => void;
  onPause?: () => void;
}

// 科技详情面板
interface TechDetailPanelProps {
  technology: Technology;
  onResearch: () => void;
  onAddToQueue: () => void;
  showPrerequisites?: boolean;
}
```

## 🔄 游戏循环与更新

### 游戏循环管理器

```typescript
class GameLoop {
  private lastUpdate: number;
  private updateInterval: number = 100; // 100ms
  
  // 启动游戏循环
  start(): void {
    this.lastUpdate = Date.now();
    this.loop();
  }
  
  // 主循环
  private loop(): void {
    const now = Date.now();
    const deltaTime = now - this.lastUpdate;
    
    // 更新各个系统
    this.updateProduction(deltaTime);
    this.updatePower(deltaTime);
    this.updateResearch(deltaTime);
    this.updateStatistics(deltaTime);
    
    this.lastUpdate = now;
    requestAnimationFrame(() => this.loop());
  }
  
  // 更新生产系统
  private updateProduction(deltaTime: number): void {
    // 更新所有设施的生产进度
    // 处理输入/输出缓冲区
    // 更新库存
  }
  
  // 更新电力系统
  private updatePower(deltaTime: number): void {
    // 计算发电量
    // 分配电力
    // 更新设施状态
  }
  
  // 更新研究系统
  private updateResearch(deltaTime: number): void {
    // 更新研究进度
    // 检查完成的研究
    // 应用解锁效果
  }
}
```

## 💾 数据持久化

### 存储方案

```typescript
class StorageService {
  private readonly STORAGE_KEY = 'factorio_game_save';
  
  // 保存游戏
  saveGame(gameState: GameState): void {
    const saveData = this.serializeGameState(gameState);
    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(saveData));
  }
  
  // 加载游戏
  loadGame(): GameState | null {
    const saveData = localStorage.getItem(this.STORAGE_KEY);
    if (!saveData) return null;
    
    return this.deserializeGameState(JSON.parse(saveData));
  }
  
  // 自动保存
  enableAutoSave(interval: number): void {
    setInterval(() => {
      this.saveGame(getGameState());
    }, interval * 60 * 1000);
  }
  
  // 导出存档
  exportSave(): string {
    const saveData = localStorage.getItem(this.STORAGE_KEY);
    return btoa(saveData || '');
  }
  
  // 导入存档
  importSave(encodedData: string): boolean {
    try {
      const saveData = atob(encodedData);
      localStorage.setItem(this.STORAGE_KEY, saveData);
      return true;
    } catch {
      return false;
    }
  }
}
```

## 🎯 性能优化策略

### 1. 渲染优化
- 使用虚拟滚动处理大量物品列表
- 实现组件懒加载
- 使用React.memo优化组件重渲染
- 批量更新DOM操作

### 2. 状态管理优化
- 使用Immer进行不可变状态更新
- 实现状态分片，避免全局更新
- 使用选择器缓存计算结果
- 实现状态订阅的细粒度控制

### 3. 计算优化
- 使用Web Workers处理复杂计算
- 实现计算结果缓存
- 优化游戏循环的更新频率
- 使用增量更新而非全量计算

### 4. 内存管理
- 及时清理不需要的对象引用
- 使用对象池管理频繁创建的对象
- 限制历史数据的保存量
- 实现资源的按需加载

## 📚 开发规范

### 代码规范
- 使用TypeScript严格模式
- 遵循ESLint规则
- 使用Prettier格式化代码
- 编写单元测试覆盖核心逻辑

### 命名规范
- 组件使用PascalCase
- 函数和变量使用camelCase
- 常量使用UPPER_SNAKE_CASE
- 类型和接口使用PascalCase

### 目录结构规范
- 每个模块一个文件夹
- 相关的类型定义放在types文件中
- 工具函数放在utils文件夹
- 测试文件与源文件同目录

### Git提交规范
- feat: 新功能
- fix: 修复bug
- docs: 文档更新
- style: 代码格式
- refactor: 重构
- test: 测试相关
- chore: 构建工具或辅助工具的变动

## 🔗 相关文档

- [第一阶段开发任务文档](./第一阶段开发任务文档.md)
- [游戏设计文档](./异星工厂v3设计文档.md)
- [电力系统设计文档](./电力系统设计文档.md)
- [科技页面设计文档](./科技页面设计文档.md)