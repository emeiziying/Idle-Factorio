# 存档优化实施计划

## 优化总结

基于分析，当前存档存在以下主要问题：

1. **库存数据冗余**：每个物品存储了9个字段，其中7个是冗余的
2. **精度过高**：设施进度精确到小数点后15位
3. **重复信息**：配方信息、堆叠大小等可从游戏配置获取
4. **数据结构冗余**：使用Map和复杂对象存储简单数据

## 实施步骤

### 第一阶段：立即可实施的优化（减少50-60%大小）

1. **简化库存存储**
   ```javascript
   // 原始: Map结构，每个物品9个字段
   // 优化: 简单对象，只存储数量
   inventory: {
     "stone": 50,
     "coal": 41,
     // ...
   }
   ```

2. **降低数值精度**
   - 设施进度：保留2位小数
   - 燃料能量：保留2位小数
   - 删除时间戳的毫秒精度

3. **移除固定值字段**
   - baseStacks (总是1)
   - additionalStacks (总是0)
   - totalStacks (总是1)
   - status (总是"normal")
   - productionRate/consumptionRate (库存总是0)

4. **使用数组代替对象**（适用于设施数据）
   ```javascript
   // 原始: 对象格式
   // 优化: 数组格式
   facilities: [
     ["id", "type", "recipe", progress, fuelData, status]
   ]
   ```

### 第二阶段：结构性优化（额外减少20-30%）

1. **实现配置分离**
   - 创建全局配置文件存储物品属性
   - 存档只引用物品ID

2. **压缩键名**
   ```javascript
   {
     v: 2,           // version
     i: {},          // inventory
     c: [],          // crafting
     f: [],          // facilities
     s: {},          // stats
     r: {},          // research
     t: 1234567890   // time
   }
   ```

3. **实现增量保存**
   - 每5分钟创建完整快照
   - 期间只保存变更记录
   - 加载时合并快照和变更

### 第三阶段：高级优化（可选）

1. **二进制格式**
   - 使用MessagePack或Protocol Buffers
   - 预计额外减少30-40%

2. **压缩算法**
   - 使用LZ4或zlib压缩
   - 适合大型存档

3. **分块存储**
   - 核心数据（库存、设施）
   - 统计数据（可选加载）
   - 历史记录（按需加载）

## 预期效果

| 优化阶段 | 存档大小 | 减少比例 | 实施难度 |
|---------|---------|---------|---------|
| 原始格式 | ~15KB | - | - |
| 第一阶段 | ~7KB | 53% | 低 |
| 第二阶段 | ~5KB | 67% | 中 |
| 第三阶段 | ~3KB | 80% | 高 |

## 兼容性方案

1. **版本标识**
   - 所有存档包含version字段
   - 支持自动格式检测

2. **迁移工具**
   - 提供双向转换函数
   - 自动升级旧存档

3. **渐进式部署**
   - 先在新存档使用
   - 提供选项让用户选择格式
   - 完全测试后全面切换

## 实施优先级

1. **高优先级**（立即实施）
   - 移除库存冗余字段
   - 降低数值精度
   - 简化数据结构

2. **中优先级**（下个版本）
   - 配置分离
   - 增量保存
   - 压缩键名

3. **低优先级**（未来考虑）
   - 二进制格式
   - 高级压缩
   - 分块存储

## 注意事项

1. **保持向后兼容**
   - 新版本能读取旧存档
   - 提供格式转换工具

2. **性能考虑**
   - 转换操作应该快速
   - 避免影响游戏性能

3. **错误处理**
   - 存档损坏时的恢复机制
   - 自动备份重要数据

4. **用户体验**
   - 透明的升级过程
   - 清晰的错误提示
   - 可选的存档格式