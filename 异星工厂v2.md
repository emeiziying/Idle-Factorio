# 异星工厂手机版 PRD - 更新版本

## 1. 产品概述

### 1.1 产品定位

基于经典 PC 游戏《Factorio》设计的移动端工厂自动化管理游戏，采用以物品为中心的简化界面设计，支持多设备类型生产和完全自动化的资源管理系统。

### 1.2 核心特色

- **物流驱动生产**：传送带和机械臂决定实际产能，取代自动获取机制
- **以物品为中心**的工厂管理界面
- **多设备类型**支持同一物品的不同生产方式
- **物流配置系统**：直观配置每个设施的输入输出物流
- **效率可视化**：实时显示瓶颈位置和优化建议
- **简化界面**专注核心数据和操作
- **本地存储**支持完全离线游戏体验
- **智能搜索**快速查找物品和配方
- **生产链可视化**直观展示物品依赖关系
- **数据分析**实时生产效率统计和优化建议

### 1.3 目标用户

- **核心用户**：25-44 岁策略游戏爱好者
- **移动用户**：偏好简洁界面的手机游戏玩家
- **Factorio 粉丝**：熟悉原版游戏机制的玩家

## 2. 功能需求规格

### 2.1 物品分类系统

#### 2.1.1 基于 Factorio 的六大分类体系

```
物品分类结构（基于Factorio 1.1.107数据）：
├── 物流系统 (Logistics) 📦
│   ├── 传送设备：传送带、地下传送带、分流器
│   ├── 搬运设备：机械臂、快速机械臂、堆叠机械臂
│   ├── 存储设备：箱子、储液罐、物流箱子
│   ├── 运输设备：火车、车厢、轨道信号
│   └── 特性：自动化物流核心，支持物品传输和存储
│
├── 生产系统 (Production) 🏭
│   ├── 开采设备：热力采掘机、电力采掘机
│   ├── 冶炼设备：石质熔炉、钢质熔炉、电炉
│   ├── 装配设备：装配机1-3型、化工厂、炼油厂
│   ├── 发电设备：蒸汽机、太阳能板、核反应堆
│   └── 特性：自动化生产核心，支持资源加工和制造
│
├── 中间产品 (Intermediate Products) ⚙️
│   ├── 金属制品：铁板、铜板、钢板、石砖
│   ├── 机械组件：铁齿轮、铜线、电路板、高级电路
│   ├── 化工产品：塑料、硫酸、润滑油、电池
│   ├── 燃料产品：固体燃料、火箭燃料、核燃料
│   └── 特性：生产链中间环节，用于制造更高级物品
│
├── 战斗系统 (Combat) ⚔️
│   ├── 武器系统：手枪、冲锋枪、火箭筒、火焰喷射器
│   ├── 弹药系统：弹夹、爆炸弹夹、铀弹夹
│   ├── 防护设备：轻型护甲、重型护甲、模块化护甲
│   ├── 防御设施：炮塔、激光炮塔、火焰炮塔
│   └── 特性：军事防御和攻击系统
│
├── 流体系统 (Fluids) 🌊
│   ├── 基础流体：水、原油、蒸汽
│   ├── 加工流体：重油、轻油、石油气
│   ├── 化工流体：硫酸、润滑油
│   ├── 特殊流体：核燃料、铀燃料
│   └── 特性：流体资源管理，支持化工生产
│
└── 科技系统 (Technology) 🧪
    ├── 科技包：自动化、物流、军事、化学、生产、实用、太空科技包
    ├── 研究设施：实验室
    ├── 科技升级：武器伤害、射击速度、机器人速度等
    └── 特性：科技研发和解锁系统，推动游戏进程
```

#### 2.1.2 基于 Factorio 的分类功能要求

- **Tab 切换**：横向滚动标签栏，支持 6 个基于 Factorio 的分类 + 生产链视图
- **显示位置**：在"生产"Tab中显示物品分类，在"设施"Tab中显示设施分类
- **图标识别**：每个分类有独特的图标和颜色，基于 Factorio 设计
- **状态指示**：显示该分类物品的生产状态和科技解锁状态
- **快速定位**：点击分类快速跳转到对应物品
- **科技关联**：显示分类中已解锁和未解锁的物品
- **配方预览**：显示分类中可用的配方数量

```typescript
// 基于Factorio的分类标签配置
const categoryTabs = [
  {
    id: "logistics",
    name: "物流系统",
    icon: "📦",
    color: "#22C55E",
    description: "传送带、机械臂、箱子等物流设备",
  },
  {
    id: "production",
    name: "生产系统",
    icon: "🏭",
    color: "#EAB308",
    description: "熔炉、装配机、采掘机等生产设备",
  },
  {
    id: "intermediate-products",
    name: "中间产品",
    icon: "⚙️",
    color: "#3B82F6",
    description: "铁板、铜板、电路板等中间产品",
  },
  {
    id: "combat",
    name: "战斗系统",
    icon: "⚔️",
    color: "#EF4444",
    description: "武器、弹药、护甲等军事装备",
  },
  {
    id: "fluids",
    name: "流体系统",
    icon: "🌊",
    color: "#06B6D4",
    description: "水、油、蒸汽等流体资源",
  },
  {
    id: "technology",
    name: "科技系统",
    icon: "🧪",
    color: "#8B5CF6",
    description: "科技包、实验室等研究设施",
  },
];
```

### 2.2 物流系统机制（新增）

#### 2.2.1 核心理念

取消设施自动获取库存的功能，引入物流设备作为生产的必要条件：
- **传送带**：用于大批量物品运输
- **机械臂**：用于精确物品搬运
- 设施的实际产能受物流设备运输能力限制

#### 2.2.2 物流设备规格

```
传送带系列：
├── 基础传送带：15 物品/秒
├── 快速传送带：30 物品/秒
└── 极速传送带：45 物品/秒

机械臂系列：
├── 基础机械臂：0.83 物品/秒
├── 快速机械臂：2.31 物品/秒
└── 极速机械臂：6.92 物品/秒
```

#### 2.2.3 效率计算公式

```
实际生产速率 = Math.min(
  设施基础产能,
  输入物流能力,  // 所有输入传送带+机械臂的总运力
  输出物流能力   // 所有输出传送带+机械臂的总运力
)
```

### 2.3 物品网格界面

#### 2.3.1 网格布局设计

```
网格布局规范：
├── 基础布局：4列 × N行
├── 卡片尺寸：90×110px (优化后尺寸)
├── 间距设置：4px物品间距，12px行间距
├── 滚动区域：垂直滚动，支持惯性滚动
└── 响应式：自适应不同屏幕宽度
```

#### 2.3.2 物品卡片设计（优化版）

```
物品卡片结构（改进版）：
┌─────────────────┐
│ ●               │ ← 状态徽章（左上角，8px）
│                 │
│   [彩色图标]     │ ← 物品图标（48×48px）
│                 │
│   物品名称       │ ← 名称（单行省略）
│   1.2K          │ ← 库存数量（简化格式）
└─────────────────┘
```

**卡片交互设计：**
- **单击**：打开物品详情
- **长按**：显示快速信息悬浮卡片
- **双击**：快速添加到制作队列（如适用）

**快速信息悬浮卡片：**
```typescript
interface QuickInfoPopup {
  trigger: 'longPress',
  duration: 500, // 500ms触发
  content: {
    fullName: string,        // 完整名称
    exactQuantity: number,   // 精确数量
    productionRate: string,  // 生产速率
    category: string,        // 所属分类
    nextProduction: string   // 下次产出时间
  },
  position: 'auto', // 自动避免遮挡
  animation: 'fadeIn'
}
```

**状态徽章设计：**
- **生产中**：绿色圆点 ● (表示正在生产)
- **停产中**：灰色圆点 ○ (表示设备停止)
- **缺料中**：橙色圆点 ⚠ (表示材料不足)
- **库存满**：红色圆点 🔴 (表示库存已满)
- **研究中**：紫色圆点 🔬 (表示科技研发中)
- **无状态**：不显示徽章 (正常状态)

**数量格式化显示：**
```typescript
function formatQuantity(num: number): string {
  if (num >= 1000000) return `${(num/1000000).toFixed(1)}M`;
  if (num >= 10000) return `${(num/1000).toFixed(0)}K`;
  if (num >= 1000) return `${(num/1000).toFixed(1)}K`;
  return num.toString();
}
```

**状态徽章实现逻辑：**
```typescript
interface ItemCardState {
  // 状态优先级（从高到低）
  priority: {
    maintenance: 1,    // 维护中 - 最高优先级
    inventoryFull: 2,  // 库存满 - 高优先级
    researching: 3,    // 研究中
    insufficient: 4,   // 缺料中
    stopped: 5,        // 停产中
    producing: 6,      // 生产中
    normal: 7          // 正常状态 - 最低优先级
  };

  // 状态判断逻辑
  getItemState(itemId: string): ItemState {
    const item = this.getItem(itemId);
    
    // 检查维护状态
    if (this.hasMaintenanceIssues(itemId)) {
      return { type: 'maintenance', color: '#EF4444', icon: '🔧' };
    }
    
    // 检查库存满状态
    if (this.isInventoryFull(itemId)) {
      return { type: 'inventoryFull', color: '#EF4444', icon: '🔴' };
    }
    
    // 检查研究状态
    if (this.isResearching(itemId)) {
      return { type: 'researching', color: '#8B5CF6', icon: '🔬' };
    }
    
    // 检查缺料状态
    if (this.hasInsufficientMaterials(itemId)) {
      return { type: 'insufficient', color: '#F59E0B', icon: '⚠' };
    }
    
    // 检查停产状态
    if (this.isStopped(itemId)) {
      return { type: 'stopped', color: '#6B7280', icon: '○' };
    }
    
    // 检查生产状态
    if (this.isProducing(itemId)) {
      return { type: 'producing', color: '#10B981', icon: '●' };
    }
    
    // 正常状态 - 不显示徽章
    return { type: 'normal', color: 'transparent', icon: '' };
  }
}
```

#### 2.3.3 搜索功能系统

```
搜索界面布局：
┌─────────────────────────────────┐
│ 🔍 搜索物品、配方或用途...  [×] │ ← 搜索栏 (40px)
├─────────────────────────────────┤
│ 最近搜索: 铁板 铜线 齿轮        │ ← 搜索历史
├─────────────────────────────────┤
│ [分类标签...]                   │ ← 分类过滤
├─────────────────────────────────┤
│ [物品网格显示搜索结果...]       │ ← 搜索结果
└─────────────────────────────────┘
```

**搜索功能规范：**
```typescript
interface SearchSystem {
  // 搜索维度
  searchDimensions: {
    itemName: true,          // 物品名称
    category: true,          // 所属分类
    recipe: true,           // 配方名称
    ingredients: true,      // 原料搜索
    usage: true,           // 用途搜索
    description: true      // 描述文本
  },
  
  // 搜索特性
  features: {
    fuzzyMatch: true,      // 模糊匹配
    pinyin: true,         // 拼音搜索
    highlighting: true,    // 高亮匹配
    suggestions: {
      enabled: true,
      maxItems: 5,
      showCategory: true
    },
    history: {
      enabled: true,
      maxItems: 10,
      persistent: true   // 持久化存储
    }
  },
  
  // 搜索结果展示
  resultDisplay: {
    groupByCategory: true,
    showRelevanceScore: false,
    maxResults: 50,
    lazyLoading: true
  }
}
```

**智能搜索示例：**
- 搜索"齿轮" → 显示铁齿轮及所有需要齿轮的配方
- 搜索"挖掘" → 显示所有采掘机类设备
- 搜索"red" → 显示红色科技包等红色相关物品

### 2.4 物流系统配置界面（新增）

#### 2.4.1 设施物流配置

在物品详情页面中，正在生产的物品会显示生产设施的物流配置面板：

```
物流配置面板结构：
┌─────────────────────────────────┐
│ 🏭 设施类型 (数量)   效率: XX%   │
├─────────────────────────────────┤
│ 基础产能: XX/秒                  │
│ 实际产能: XX/秒                  │
│ [效率进度条]                     │
├─────────────────────────────────┤
│ 📥 输入物流（如需要）             │
│ 需求: XX/秒  当前: XX/秒         │
│ 传送带: [类型] [-][数量][+]      │
│ 机械臂: [类型] [-][数量][+]      │
├─────────────────────────────────┤
│ 📤 输出物流                      │
│ 需求: XX/秒  当前: XX/秒         │
│ 传送带: [类型] [-][数量][+]      │
│ 机械臂: [类型] [-][数量][+]      │
├─────────────────────────────────┤
│ 💡 优化建议                      │
└─────────────────────────────────┘
```

**关键特性：**
- **实时计算**：调整物流配置时立即更新实际产能
- **瓶颈识别**：自动识别是输入还是输出限制了生产
- **智能建议**：提供最优的物流设备组合方案
- **视觉反馈**：通过颜色和进度条显示效率状态

#### 2.4.2 物流配置示例

**示例1：铁矿开采**
```
设施：电力采掘机 × 3
基础产能：15物品/秒（每台5/秒）
输入需求：无（采掘机不需要输入）
输出需求：15物品/秒

配置方案：
- 方案A：1个基础传送带（15/秒）✓
- 方案B：7个快速机械臂（16.17/秒）✓
- 方案C：3个极速机械臂（20.76/秒）✓
```

**示例2：铁板冶炼**
```
设施：电炉 × 2
基础产能：4物品/秒（每台2/秒）
输入需求：4个铁矿/秒
输出需求：4个铁板/秒

最小配置：
- 输入：2个快速机械臂（4.62/秒）
- 输出：2个快速机械臂（4.62/秒）
```

### 2.5 简化物品详情系统

#### 2.5.1 基于 Factorio 的详情页面结构

```
简化详情页面布局：
┌─────────────────────────────────┐
│ [图标] 物品名称          [×关闭] │
├─────────────────────────────────┤
│ 📊 核心数据区域                  │
│ 库存: 245/1000  净增长: +12.5/秒 │
│ 产量: +15.0/秒  消耗: -2.5/秒   │
│ 科技状态: 已解锁/未解锁         │
├─────────────────────────────────┤
│ 📦 存储管理区域                  │
│ 存储设备: 铁箱子 × 1            │
│ [添加箱子] [移除箱子]           │
├─────────────────────────────────┤
│ 🔗 生产链预览 (新增)             │
│ 上游: 铁矿石 → 熔炉 → 铁板       │
│ 下游: 铁板 → 铁齿轮/铁箱子       │
├─────────────────────────────────┤
│ 📋 配方信息区域 (条件显示)       │
│ 制作时间: 0.5秒  解锁科技: 自动化│
│ 输入: 铁板×8  输出: 铁箱子×1    │
├─────────────────────────────────┤
│ 🔨 手动操作区域 (条件显示)       │
│ [手动开采] [手动制作]           │
├─────────────────────────────────┤
│ 🏭 生产设施管理（配置物流）        │
│ 电力采掘机 (3台)     效率: 67%   │
│ 基础产能: 15.0/秒                │
│ 实际产能: 10.0/秒 ⚠️             │
│                                 │
│ 📤 输出物流                      │
│ 需求: 15.0/秒  当前: 10.0/秒     │
│ 传送带: [0] [-][+]               │
│ 机械臂: [12] [-][+]              │
│                                 │
│ 💡 建议：添加1个基础传送带        │
└─────────────────────────────────┘
```

#### 2.5.2 生产链预览系统（新增）

```typescript
interface ProductionChainPreview {
  // 简化的生产链展示
  display: {
    maxUpstreamNodes: 3,    // 最多显示3个上游节点
    maxDownstreamNodes: 3,  // 最多显示3个下游节点
    showEquipment: true,    // 显示生产设备
    interactive: true       // 点击可跳转
  },
  
  // 可视化样式
  visualization: {
    nodeStyle: {
      size: 32,           // 节点大小
      showIcon: true,     // 显示物品图标
      showQuantity: true  // 显示数量关系
    },
    edgeStyle: {
      animated: true,     // 流动动画
      showRate: true      // 显示流量
    }
  },
  
  // 交互功能
  interactions: {
    nodeClick: 'navigateToItem',  // 点击跳转到物品
    expandable: true,             // 可展开查看完整链
    tooltip: true                 // 悬停显示详情
  }
}
```

#### 2.5.3 核心数据区域

**数据项定义：**

- **库存数量**：当前拥有的物品总数
- **库存上限**：通过箱子/储罐提供的最大存储容量
- **净增长量**：每秒实际增长量（产量-消耗量）
- **每秒产量**：所有生产设备的产量总和
- **每秒消耗**：作为其他物品原料的消耗速度

#### 2.5.4 存储管理区域

**存储系统设计：**

```
库存上限管理：
├── 基础存储：每种物品默认100个存储上限
├── 箱子扩容：每个铁箱子增加1000个存储容量
├── 储罐扩容：每个储液罐增加25000个流体容量
├── 自动停止：达到上限时自动停止相关生产设备
└── 溢出保护：防止库存超过上限导致的数据错误
```

**存储设备类型：**

```typescript
interface StorageDevice {
  id: string;
  name: string;
  capacity: number;
  itemType: "solid" | "fluid";
  unlockedBy?: string;
}

const storageDevices: { [id: string]: StorageDevice } = {
  // 固体物品存储
  "iron-chest": {
    id: "iron-chest",
    name: "铁箱子",
    capacity: 1000,
    itemType: "solid",
    unlockedBy: "automation",
  },

  "steel-chest": {
    id: "steel-chest", 
    name: "钢箱子",
    capacity: 2000,
    itemType: "solid",
    unlockedBy: "steel-processing",
  },

  // 流体物品存储
  "storage-tank": {
    id: "storage-tank",
    name: "储液罐",
    capacity: 25000,
    itemType: "fluid",
    unlockedBy: "fluid-handling",
  },
};
```

**存储管理界面：**

```
存储管理区域设计：
┌─────────────────────────────────┐
│ 📦 存储管理                     │
├─────────────────────────────────┤
│ 当前库存: 245/1000              │
│ 存储设备: 铁箱子 × 1            │
│ [添加箱子] [移除箱子]           │
├─────────────────────────────────┤
│ 状态: 生产中 (未达上限)          │
│ 或: 已满 (停止生产)             │
└─────────────────────────────────┘
```

**添加设备时的库存检查：**

```
添加设备流程：
├── 点击添加按钮
├── 检查箱子/储罐库存
│   ├── 有库存：消耗1个箱子，增加存储容量
│   └── 无库存：显示提示"库存不足：需要铁箱子但当前没有库存"
├── 更新存储设备列表
└── 刷新界面显示
```

**按钮状态管理：**

```
按钮状态逻辑：
├── 添加按钮：
│   ├── 有箱子库存：高亮可点击
│   └── 无箱子库存：置灰不可点击
├── 移除按钮：
│   ├── 有存储设备：高亮可点击
│   └── 无存储设备：置灰不可点击
└── 状态提示：
    ├── 库存充足：显示"可添加"
    └── 库存不足：显示"库存不足"
```

**存储管理功能：**

- **添加存储设备**：点击添加按钮，消耗箱子/储罐库存建造存储设备
- **移除存储设备**：点击移除按钮，减少存储容量（需要确认）
- **容量显示**：实时显示当前库存和最大容量
- **状态指示**：显示存储状态（未满/已满）
- **自动管理**：达到上限时自动停止相关生产设备
- **库存检查**：添加设备前检查是否有足够的箱子/储罐库存

**库存上限实现逻辑：**

```typescript
class InventoryLimitManager {
  // 库存上限数据结构
  interface InventoryLimit {
    itemId: string;
    currentAmount: number;
    maxCapacity: number;
    storageDevices: StorageDeviceInstance[];
    isFull: boolean;
  }

  // 检查库存是否达到上限
  checkInventoryLimit(itemId: string): boolean {
    const limit = this.getInventoryLimit(itemId);
    return limit.currentAmount >= limit.maxCapacity;
  }

  // 更新库存上限
  updateInventoryLimit(itemId: string, newAmount: number): void {
    const limit = this.getInventoryLimit(itemId);
    
    // 防止超过上限
    if (newAmount > limit.maxCapacity) {
      newAmount = limit.maxCapacity;
      this.notifyInventoryFull(itemId);
    }
    
    limit.currentAmount = newAmount;
    limit.isFull = newAmount >= limit.maxCapacity;
    
    // 如果达到上限，停止相关生产设备
    if (limit.isFull) {
      this.stopProductionDevices(itemId);
    }
  }

  // 添加存储设备
  addStorageDevice(itemId: string, deviceType: string): boolean {
    const device = storageDevices[deviceType];
    if (!device) return false;
    
    // 检查是否有足够的箱子/储罐库存
    if (!this.hasEnoughStorageDevice(deviceType)) {
      this.notifyInsufficientStorageDevice(deviceType);
      return false;
    }
    
    // 消耗箱子/储罐库存
    this.consumeStorageDevice(deviceType);
    
    // 增加存储容量
    const limit = this.getInventoryLimit(itemId);
    limit.maxCapacity += device.capacity;
    limit.storageDevices.push({
      type: deviceType,
      capacity: device.capacity
    });
    
    return true;
  }

  // 移除存储设备
  removeStorageDevice(itemId: string, deviceIndex: number): boolean {
    const limit = this.getInventoryLimit(itemId);
    const device = limit.storageDevices[deviceIndex];
    
    if (!device) return false;
    
    // 检查移除后是否会导致库存溢出
    const newCapacity = limit.maxCapacity - device.capacity;
    if (limit.currentAmount > newCapacity) {
      this.notifyCannotRemoveDevice(itemId, "库存将溢出");
      return false;
    }
    
    // 移除设备
    limit.maxCapacity -= device.capacity;
    limit.storageDevices.splice(deviceIndex, 1);
    
    return true;
  }

  // 停止生产设备
  private stopProductionDevices(itemId: string): void {
    const devices = this.getProductionDevices(itemId);
    devices.forEach(device => {
      device.working = false;
      device.status = "stopped_full_inventory";
    });
  }

  // 检查是否有足够的存储设备库存
  private hasEnoughStorageDevice(deviceType: string): boolean {
    const currentStock = this.getInventoryAmount(deviceType);
    return currentStock > 0;
  }

  // 消耗存储设备库存
  private consumeStorageDevice(deviceType: string): void {
    this.decreaseInventory(deviceType, 1);
  }

  // 通知存储设备库存不足
  private notifyInsufficientStorageDevice(deviceType: string): void {
    const deviceName = storageDevices[deviceType]?.name || deviceType;
    this.showNotification(`库存不足：需要 ${deviceName} 但当前没有库存`);
  }

  // 获取存储设备库存信息
  getStorageDeviceStockInfo(): StorageDeviceStockInfo[] {
    return Object.keys(storageDevices).map(deviceType => ({
      deviceType,
      deviceName: storageDevices[deviceType].name,
      currentStock: this.getInventoryAmount(deviceType),
      canAdd: this.getInventoryAmount(deviceType) > 0
    }));
  }
}

// 存储设备库存信息接口
interface StorageDeviceStockInfo {
  deviceType: string;
  deviceName: string;
  currentStock: number;
  canAdd: boolean;
}

// 使用示例：为铁板添加铁箱子存储
const ironPlateStorageExample = {
  // 检查铁箱子库存
  ironChestStock: 5, // 当前有5个铁箱子
  
  // 添加存储设备
  addIronChestToIronPlate: () => {
    if (ironChestStock > 0) {
      // 消耗1个铁箱子
      ironChestStock--;
      
      // 为铁板增加1000存储容量
      ironPlateMaxCapacity += 1000;
      
      return { success: true, message: "已添加铁箱子存储" };
    } else {
      return { success: false, message: "库存不足：需要铁箱子但当前没有库存" };
    }
  }
};
```

#### 2.5.5 配方信息区域

**显示条件：**
- 物品有制作配方时显示
- 配方已解锁时显示完整信息
- 配方未解锁时显示锁定状态

**信息展示：**
- **制作时间**：配方的基础制作时间
- **解锁科技**：解锁该配方的科技名称
- **输入材料**：制作所需的原材料及数量
- **输出物品**：制作产出的物品及数量
- **制作设备**：可用于制作该配方的设备类型

**基于 Factorio 的计算公式：**

```typescript
// 基于Factorio的生产速率计算
interface ProductionCalculation {
  // 每秒产量计算
  productionPerSecond = Σ(
    设备基础速度 ×
    设备等级系数 ×
    设备效率系数 ×
    模块加成系数 ×
    工作状态系数
  );

  // 每秒消耗计算 (基于配方数据)
  consumptionPerSecond = Σ(
    消耗该物品的配方产量 ×
    配方中该物品的消耗比例
  );

  // 净增长量
  netGrowth = productionPerSecond - consumptionPerSecond;

  // 科技解锁状态
  isUnlocked = 检查科技解锁状态(物品ID);

  // 可用配方
  availableRecipes = 获取可用配方(物品ID);
}

// 示例：铁板的生产计算
const ironPlateCalculation = {
  // 生产设备
  electricMiningDrills: 5, // 5台电力采掘机
  stoneFurnaces: 3,        // 3台石质熔炉

  // 产量计算
  miningProduction: 5 × 0.5 × 1.0 = 2.5 铁矿石/秒,
  smeltingProduction: 3 × 1.0 × 1.0 = 3.0 铁板/秒,

  // 消耗计算 (作为其他物品原料)
  consumption: 计算作为原料的消耗,

  // 净增长
  netGrowth: 3.0 - 消耗量
};
```

#### 2.5.6 手动操作区域

**显示条件：**

- **手动开采**：原材料类物品且可开采时显示
- **手动制作**：有制作配方的物品显示

**操作功能：**

- 点击后添加任务到制作队列
- 显示预计完成时间
- 检查材料充足性

**移动端制作按钮设计：**

```
手动制作按钮布局：
┌─────────────────────────────────┐
│ 🔨 手工制作                     │
├─────────────────────────────────┤
│ [制作1个] [制作5个] [最多制造]   │
│ 材料充足 ✓ 预计时间: 2.5秒      │
└─────────────────────────────────┘
```

**按钮功能：**

- **制作 1 个按钮**：添加 1 个制作任务到队列
- **制作 5 个按钮**：添加 5 个制作任务到队列
- **最多制造按钮**：根据材料数量添加最大可制作数量的任务

**状态显示：**

- 材料充足时按钮高亮，材料不足时按钮置灰
- 显示预计完成时间
- 显示材料消耗提示

#### 2.5.7 生产设施列表

**设施卡片设计：**

```
设施卡片结构：
┌─────────────────────────────────┐
│ 设施名称                        │
│ X台 | 产能: +XX.X/秒             │
│ ●●○ 2/3 运行中     [-] 3 [+]    │
└─────────────────────────────────┘
```

**信息展示：**

- **设施名称**：设备类型名称
- **数量统计**：该类设施的总数量
- **总产能**：该类设施的总产量
- **运行状态**：用彩色圆点显示每台设备状态（绿=运行，红=停止）
- **数量控制**：增减按钮直接调整设施数量

### 2.6 设备管理系统（已更新为物流驱动）

#### 2.6.1 基于 Factorio 的设备类型定义

```typescript
// 基于Factorio 1.1.107数据的设备类型定义
interface EquipmentType {
  id: string;
  name: string;
  category: "mining" | "smelting" | "assembly" | "chemical" | "research";
  baseSpeed: number;
  powerType: "fuel" | "electric";
  powerConsumption?: number; // kW
  fuelType?: "coal" | "wood" | "solid-fuel";
  cost: { [itemId: string]: number };
  canProduce: string[]; // 可生产的物品ID列表
  efficiency: number;
  unlockedBy?: string; // 解锁科技ID
}

// 主要设备类型定义
const equipmentTypes: { [id: string]: EquipmentType } = {
  // 开采设备
  "burner-mining-drill": {
    id: "burner-mining-drill",
    name: "热力采掘机",
    category: "mining",
    baseSpeed: 0.25,
    powerType: "fuel",
    fuelType: "coal",
    cost: { "stone-furnace": 1, "iron-gear-wheel": 3, "iron-plate": 3 },
    canProduce: ["iron-ore", "copper-ore", "coal", "stone", "uranium-ore"],
    efficiency: 1.0,
  },

  "electric-mining-drill": {
    id: "electric-mining-drill",
    name: "电力采掘机",
    category: "mining",
    baseSpeed: 0.5,
    powerType: "electric",
    powerConsumption: 90,
    cost: { "electronic-circuit": 3, "iron-gear-wheel": 5, "iron-plate": 10 },
    canProduce: ["iron-ore", "copper-ore", "coal", "stone", "uranium-ore"],
    efficiency: 1.0,
    unlockedBy: "automation",
  },

  // 冶炼设备
  "stone-furnace": {
    id: "stone-furnace",
    name: "石质熔炉",
    category: "smelting",
    baseSpeed: 1.0,
    powerType: "fuel",
    fuelType: "coal",
    cost: { stone: 5 },
    canProduce: ["iron-plate", "copper-plate", "steel-plate", "stone-brick"],
    efficiency: 1.0,
  },

  "steel-furnace": {
    id: "steel-furnace",
    name: "钢质熔炉",
    category: "smelting",
    baseSpeed: 2.0,
    powerType: "fuel",
    fuelType: "coal",
    cost: { "steel-plate": 6, "advanced-circuit": 10, "stone-brick": 10 },
    canProduce: ["iron-plate", "copper-plate", "steel-plate", "stone-brick"],
    efficiency: 1.0,
    unlockedBy: "steel-processing",
  },

  "electric-furnace": {
    id: "electric-furnace",
    name: "电炉",
    category: "smelting",
    baseSpeed: 2.0,
    powerType: "electric",
    powerConsumption: 180,
    cost: { "advanced-circuit": 5, "steel-plate": 10, "stone-brick": 10 },
    canProduce: ["iron-plate", "copper-plate", "steel-plate", "stone-brick"],
    efficiency: 1.0,
    unlockedBy: "advanced-material-processing",
  },

  // 装配设备
  "assembling-machine-1": {
    id: "assembling-machine-1",
    name: "装配机1型",
    category: "assembly",
    baseSpeed: 0.5,
    powerType: "electric",
    powerConsumption: 77,
    cost: { "electronic-circuit": 3, "iron-gear-wheel": 5, "iron-plate": 9 },
    canProduce: [], // 可生产所有有配方的物品
    efficiency: 1.0,
    unlockedBy: "automation",
  },

  "assembling-machine-2": {
    id: "assembling-machine-2",
    name: "装配机2型",
    category: "assembly",
    baseSpeed: 0.75,
    powerType: "electric",
    powerConsumption: 155,
    cost: {
      "assembling-machine-1": 1,
      "electronic-circuit": 2,
      "iron-gear-wheel": 5,
    },
    canProduce: [], // 可生产所有有配方的物品
    efficiency: 1.0,
    unlockedBy: "automation-2",
  },

  "assembling-machine-3": {
    id: "assembling-machine-3",
    name: "装配机3型",
    category: "assembly",
    baseSpeed: 1.25,
    powerType: "electric",
    powerConsumption: 388,
    cost: {
      "assembling-machine-2": 1,
      "speed-module": 4,
      "advanced-circuit": 2,
    },
    canProduce: [], // 可生产所有有配方的物品
    efficiency: 1.0,
    unlockedBy: "automation-3",
  },

  // 化工设备
  "chemical-plant": {
    id: "chemical-plant",
    name: "化工厂",
    category: "chemical",
    baseSpeed: 1.0,
    powerType: "electric",
    powerConsumption: 210,
    cost: { "steel-plate": 5, "electronic-circuit": 5, "iron-gear-wheel": 5 },
    canProduce: [
      "sulfuric-acid",
      "plastic-bar",
      "sulfur",
      "battery",
      "lubricant",
    ],
    efficiency: 1.0,
    unlockedBy: "oil-processing",
  },

  "oil-refinery": {
    id: "oil-refinery",
    name: "炼油厂",
    category: "chemical",
    baseSpeed: 1.0,
    powerType: "electric",
    powerConsumption: 420,
    cost: {
      "steel-plate": 10,
      "electronic-circuit": 10,
      "iron-gear-wheel": 10,
    },
    canProduce: ["heavy-oil", "light-oil", "petroleum-gas"],
    efficiency: 1.0,
    unlockedBy: "oil-processing",
  },

  // 研究设备
  lab: {
    id: "lab",
    name: "实验室",
    category: "research",
    baseSpeed: 1.0,
    powerType: "electric",
    powerConsumption: 60,
    cost: {
      "electronic-circuit": 10,
      "iron-gear-wheel": 4,
      "transport-belt": 4,
    },
    canProduce: [], // 只用于科技研究
    efficiency: 1.0,
    unlockedBy: "automation",
  },
};
```

#### 2.6.2 基于 Factorio 的配方数据结构

```typescript
// 基于Factorio 1.1.107数据的配方结构
interface Recipe {
  id: string; // 配方唯一ID
  name: string; // 显示名称
  category: string; // 分类 (logistics, production, crafting-with-fluid等)
  row: number; // 科技树行位置
  time: number; // 制作时间(秒)
  producers: string[]; // 可生产此配方的机器列表
  in: { [itemId: string]: number }; // 输入材料及数量
  out: { [itemId: string]: number }; // 输出物品及数量
  unlockedBy?: string; // 解锁此配方的科技ID
}

// 示例配方数据
const recipeExamples: Recipe[] = [
  {
    id: "iron-chest",
    name: "Iron chest",
    category: "logistics",
    row: 0,
    time: 0.5,
    producers: [
      "assembling-machine-1",
      "assembling-machine-2",
      "assembling-machine-3",
    ],
    in: { "iron-plate": 8 },
    out: { "iron-chest": 1 },
  },

  {
    id: "transport-belt",
    name: "Transport belt",
    category: "logistics",
    row: 1,
    time: 0.5,
    producers: [
      "assembling-machine-1",
      "assembling-machine-2",
      "assembling-machine-3",
    ],
    in: { "iron-plate": 1, "iron-gear-wheel": 1 },
    out: { "transport-belt": 2 },
  },

  {
    id: "express-transport-belt",
    name: "Express transport belt",
    category: "crafting-with-fluid",
    row: 1,
    time: 0.5,
    producers: ["assembling-machine-2", "assembling-machine-3"],
    in: { "iron-gear-wheel": 10, "fast-transport-belt": 1, lubricant: 20 },
    out: { "express-transport-belt": 1 },
    unlockedBy: "logistics-3",
  },

  {
    id: "concrete",
    name: "Concrete",
    category: "crafting-with-fluid",
    row: 8,
    time: 10,
    producers: ["assembling-machine-2", "assembling-machine-3"],
    in: { "stone-brick": 5, "iron-ore": 1, water: 100 },
    out: { concrete: 10 },
    unlockedBy: "concrete-technology",
  },
];

// 设备实例数据结构
interface EquipmentInstance {
  id: string; // 唯一标识符
  type: string; // 设备类型ID
  level: number; // 设备等级
  efficiency: number; // 效率系数
  working: boolean; // 工作状态布尔值

  // 燃料设备专有属性
  fuel?: number; // 当前燃料量
  maxFuel?: number; // 最大燃料容量
  fuelType?: string; // 燃料类型

  // 电力设备专有属性
  powerConnected?: boolean; // 电力连接状态
  powerConsumption?: number; // 电力消耗

  // 模块插槽
  modules?: { [slotIndex: number]: ModuleInstance };

  // 状态信息
  lastMaintenance?: number; // 最后维护时间
  totalRuntime?: number; // 总运行时间
  totalProduction?: number; // 总产量
}

// 设备实例管理结构
interface EquipmentManagement {
  [itemId: string]: {
    [equipmentType: string]: EquipmentInstance[];
  };
}
```

#### 2.6.3 物流驱动生产机制（更新）

**物流配置要求：**

```
物流驱动机制：
1. 所有设施必须配置物流设备才能工作
2. 输入物流：运送原料和燃料到设施
3. 输出物流：运送产品离开设施
4. 实际产能受物流能力限制
5. 物流不足导致效率下降
6. 无物流配置则设施停止工作
```

**效率计算流程：**

```
生产效率计算：
1. 计算设施基础产能（设施数量 × 单台产能）
2. 计算输入物流总能力（传送带 + 机械臂）
3. 计算输出物流总能力（传送带 + 机械臂）
4. 实际产能 = Min(基础产能, 输入能力, 输出能力)
5. 效率 = 实际产能 / 基础产能
6. 识别瓶颈位置（输入/输出/无）
```

### 2.7 制作队列系统

#### 2.5.1 队列界面设计

**简化移动端设计：**

```
制作队列布局（简化版）：
┌─────────────────────────────────┐
│ 🔧 制作队列 (3/10)               │
├─────────────────────────────────┤
│  [图标+环形进度] [图标+环形进度] │
│  [图标+环形进度] [图标+环形进度] │
│  [图标+环形进度] [图标+环形进度] │
│  ...（网格排列，最多显示10个）   │
└─────────────────────────────────┘
```

**设计特点：**

- **简洁界面**：只显示图标和环形进度条
- **环形进度**：半透明环形进度条覆盖在图标上
- **点击取消**：点击图标即可取消对应制作任务
- **网格排列**：多个任务以网格形式排列，节省空间
- **进度显示**：环形进度条显示制作进度百分比
- **专注队列**：制作队列界面专注于显示队列状态，制作按钮在物品详情页

**移动端展示方案：**

**方案 1：浮动气泡式设计（推荐）**

```
┌─────────────────────────────────┐
│ 主界面内容                      │
│                                │
│                    [🔧3] ← 浮动 │
│                                │
└─────────────────────────────────┘
```

**浮动气泡特点：**
- **空间效率**：平时只占用很小空间，不遮挡主要内容
- **快速预览**：显示队列数量，用户可快速了解状态
- **按需展开**：点击气泡展开详细队列界面
- **智能显示**：队列为空时自动隐藏气泡
- **可拖拽**：支持拖拽调整位置，避免遮挡重要内容

**展开后的详细界面：**
```
┌─────────────────────────────────┐
│ 🔧 制作队列 (3/10)               │
├─────────────────────────────────┤
│  [图标+环形进度] [图标+环形进度] │
│  [图标+环形进度] [图标+环形进度] │
│  [图标+环形进度] [图标+环形进度] │
│  ...（网格排列，最多显示10个）   │
└─────────────────────────────────┘
```

**推荐方案特点：**
- **浮动气泡**：空间效率最高，用户体验最佳
- **智能显示**：队列为空时隐藏，有任务时显示
- **快速访问**：点击即可查看详细队列
- **可拖拽**：支持手势拖拽调整位置
- **结合展开**：点击气泡展开详细队列界面

#### 2.5.2 队列功能规范

- **容量限制**：最多 10 个任务并发
- **进度显示**：环形进度条显示制作进度百分比
- **状态标识**：制作中、等待中、材料不足等状态（通过进度条颜色区分）
- **取消功能**：点击图标即可取消对应制作任务
- **自动排队**：手动操作自动添加到队列末尾
- **网格布局**：多个任务以网格形式排列，节省屏幕空间

### 2.8 基于 Factorio 的手动生产队列系统

#### 2.6.1 手动生产队列机制

基于[Factorio Wiki](https://wiki.factorio.com/Crafting#Manual_crafting)的官方文档，手动生产队列是玩家通过手动操作来安排物品生产任务的核心系统。

**移动端队列操作方式：**

- **制作 1 个按钮**：点击后队列中添加 1 个制作任务
- **制作 5 个按钮**：点击后队列中添加 5 个制作任务
- **最多制造按钮**：点击后根据当前材料数量，队列中添加最大可制作数量的任务

**队列显示位置：**

- 队列显示在屏幕左下角
- 显示当前正在进行的制作操作
- 可以同时显示多个制作任务

#### 2.6.2 材料预扣机制

```typescript
interface ManualCraftingQueue {
  // 材料预扣
  preemptivelyConsumeMaterials(recipe: Recipe, quantity: number): boolean {
    const requiredMaterials = this.calculateRequiredMaterials(recipe, quantity);

    // 检查库存是否足够
    if (!this.hasEnoughMaterials(requiredMaterials)) {
      return false;
    }

    // 预扣材料
    this.consumeMaterials(requiredMaterials);
    return true;
  }

  // 取消时返还材料
  cancelCraftingAndReturnMaterials(taskId: string): void {
    const task = this.getTask(taskId);
    if (task) {
      // 返还已预扣的材料
      this.returnMaterials(task.consumedMaterials);
      this.removeTask(taskId);
    }
  }
}
```

#### 2.6.3 链式制作支持

```typescript
class ChainCraftingManager {
  // 检查中间产品
  checkIntermediateProducts(recipe: Recipe): IntermediateProduct[] {
    return recipe.ingredients
      .filter((ingredient) => !this.hasEnough(ingredient))
      .map((ingredient) => ({
        itemId: ingredient.itemId,
        required: ingredient.quantity,
        available: this.getAvailable(ingredient.itemId),
        canCraft: this.canCraftItem(ingredient.itemId),
      }));
  }

  // 自动链式制作
  autoChainCraft(targetRecipe: Recipe, quantity: number): CraftingTask[] {
    const tasks: CraftingTask[] = [];
    const intermediateProducts = this.checkIntermediateProducts(targetRecipe);

    intermediateProducts.forEach((product) => {
      if (product.canCraft && product.available < product.required) {
        const needed = product.required - product.available;
        const craftingTask = this.createCraftingTask(product.itemId, needed);
        tasks.push(craftingTask);
      }
    });

    // 添加目标制作任务
    tasks.push(this.createCraftingTask(targetRecipe.id, quantity));
    return tasks;
  }
}
```

#### 2.6.4 取消操作机制

```typescript
class CraftingQueueController {
  // 取消单个制作
  cancelOneCrafting(itemId: string): void {
    const item = this.findQueuedItem(itemId);
    if (item) {
      this.returnMaterials(item.consumedMaterials);
      this.removeFromQueue(item);
    }
  }

  // 取消5个制作
  cancelFiveCrafting(itemId: string): void {
    const items = this.findQueuedItems(itemId, 5);
    items.forEach((item) => {
      this.returnMaterials(item.consumedMaterials);
      this.removeFromQueue(item);
    });
  }

  // 取消所有该物品的制作
  cancelAllCrafting(itemId: string): void {
    const allItems = this.findQueuedItems(itemId);
    allItems.forEach((item) => {
      this.returnMaterials(item.consumedMaterials);
      this.removeFromQueue(item);
    });
  }
}
```

#### 2.6.5 特殊限制和规则

**无法手动制作的物品：**

```typescript
const MANUAL_CRAFTING_RESTRICTIONS = {
  // 矿石只能通过熔炉冶炼
  smeltingOnly: ["iron-ore", "copper-ore", "stone", "coal"],

  // 需要液体的配方
  requiresFluid: ["engine-unit", "electric-engine-unit", "flying-robot-frame"],

  // 必须在组装机中制作
  assemblyMachineOnly: ["engine-unit", "electric-engine-unit"],
};

class ManualCraftingValidator {
  canCraftManually(recipeId: string): boolean {
    const recipe = this.getRecipe(recipeId);

    // 检查是否包含液体
    if (recipe.ingredients.some((ing) => ing.type === "fluid")) {
      return false;
    }

    // 检查是否在限制列表中
    if (MANUAL_CRAFTING_RESTRICTIONS.assemblyMachineOnly.includes(recipe.id)) {
      return false;
    }

    return true;
  }
}
```

**库存满时的处理：**

```typescript
class InventoryCraftingManager {
  // 检查库存空间
  checkInventorySpace(recipe: Recipe, quantity: number): boolean {
    const outputItem = recipe.output;
    const totalOutput = outputItem.quantity * quantity;

    return this.hasEnoughInventorySpace(outputItem.itemId, totalOutput);
  }

  // 库存满时暂停制作
  handleInventoryFull(): void {
    if (this.isInventoryFull()) {
      this.pauseCrafting();
      this.showNotification("库存已满，制作已暂停");
    }
  }
}
```

#### 2.6.6 链式制作优势

```typescript
class ChainCraftingAdvantage {
  // 自动制作中间产品
  autoCraftIntermediates(targetRecipe: Recipe): void {
    const intermediates = this.getRequiredIntermediates(targetRecipe);

    intermediates.forEach((intermediate) => {
      if (!this.hasEnough(intermediate.itemId)) {
        // 自动添加到制作队列
        this.addToCraftingQueue(intermediate.itemId, intermediate.quantity);
      }
    });
  }

  // 与自动化制作的区别
  compareWithAutomation(): string {
    return `
      手动制作优势：
      - 自动链式制作中间产品
      - 无需为每个中间产品设置单独的组装机
      - 更灵活的材料管理
      
      自动化制作限制：
      - 每个制作步骤需要单独的组装机
      - 需要手动设置传送带和机械臂
      - 无法自动链式制作
    `;
  }
}
```

#### 2.6.7 用户界面设计

```typescript
interface ManualCraftingQueueUI {
  // 显示简化制作队列
  displayCraftingQueue(): JSX.Element {
    return (
      <View style={styles.craftingQueue}>
        <Text style={styles.queueTitle}>制作队列 ({this.queue.length}/10)</Text>

        {/* 简化队列显示 - 网格布局 */}
        <View style={styles.queueGrid}>
          {this.queue.map(task => (
            <CraftingTaskIcon
              key={task.id}
              task={task}
              onCancel={() => this.craftingQueue.cancelTask(task.id)}
            />
          ))}
        </View>
      </View>
    );
  }
}

// 底部抽屉式面板组件
interface BottomDrawerProps {
  isVisible: boolean;
  onClose: () => void;
  children: React.ReactNode;
}

const BottomDrawer: React.FC<BottomDrawerProps> = ({
  isVisible,
  onClose,
  children
}) => {
  return (
    <Modal
      visible={isVisible}
      transparent={true}
      animationType="slide"
      onRequestClose={onClose}
    >
      <View style={styles.drawerOverlay}>
        <TouchableOpacity
          style={styles.drawerBackdrop}
          onPress={onClose}
        />
        <View style={styles.drawerContent}>
          {/* 拖拽指示器 */}
          <View style={styles.dragIndicator} />
          {children}
        </View>
      </View>
    </Modal>
  );
};

// 浮动气泡组件（主要推荐方案）
interface FloatingBubbleProps {
  queueCount: number;
  onPress: () => void;
  position?: { x: number; y: number };
  onPositionChange?: (position: { x: number; y: number }) => void;
}

const FloatingBubble: React.FC<FloatingBubbleProps> = ({ 
  queueCount, 
  onPress,
  position = { x: 20, y: 100 },
  onPositionChange
}) => {
  const [bubblePosition, setBubblePosition] = useState(position);
  
  // 队列为空时隐藏气泡
  if (queueCount === 0) return null;
  
  const handlePanGesture = (event: any) => {
    const newPosition = {
      x: event.nativeEvent.pageX - 30, // 30是气泡半径
      y: event.nativeEvent.pageY - 30
    };
    setBubblePosition(newPosition);
    onPositionChange?.(newPosition);
  };
  
  return (
    <PanGestureHandler onGestureEvent={handlePanGesture}>
      <Animated.View style={[styles.floatingBubble, bubblePosition]}>
        <TouchableOpacity onPress={onPress}>
          <Text style={styles.bubbleText}>🔧{queueCount}</Text>
        </TouchableOpacity>
      </Animated.View>
    </PanGestureHandler>
  );
};

// 浮动气泡样式
const styles = StyleSheet.create({
  floatingBubble: {
    position: 'absolute',
    width: 60,
    height: 60,
    borderRadius: 30,
    backgroundColor: 'rgba(34, 197, 94, 0.9)', // 绿色半透明
    justifyContent: 'center',
    alignItems: 'center',
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.25,
    shadowRadius: 4,
    elevation: 5,
    zIndex: 1000,
  },
  bubbleText: {
    color: 'white',
    fontSize: 16,
    fontWeight: 'bold',
  },
});
```

// 环形进度条组件
interface CraftingTaskIcon {
task: CraftingTask;
onCancel: () => void;
}

const CraftingTaskIcon: React.FC<CraftingTaskIcon> = ({ task, onCancel }) => {
const progress = task.progress / task.totalTime;

return (
<TouchableOpacity style={styles.taskIcon} onPress={onCancel}>
{/_ 物品图标 _/}
<Image source={getItemIcon(task.itemId)} style={styles.itemIcon} />

      {/* 环形进度条覆盖 */}
      <View style={styles.progressOverlay}>
        <CircularProgress
          progress={progress}
          size={60}
          strokeWidth={4}
          strokeColor={getProgressColor(task.status)}
          backgroundColor="rgba(255,255,255,0.3)"
        />
      </View>

      {/* 进度百分比 */}
      <Text style={styles.progressText}>
        {Math.round(progress * 100)}%
      </Text>
    </TouchableOpacity>

);
};

// 进度条颜色映射
const getProgressColor = (status: string): string => {
switch (status) {
case 'in_progress': return '#22C55E'; // 绿色 - 制作中
case 'waiting': return '#F59E0B'; // 橙色 - 等待中
case 'blocked': return '#EF4444'; // 红色 - 材料不足
default: return '#6B7280'; // 灰色 - 默认
}
};

```

**简化设计规范：**

- **图标尺寸**：60x60px，适合手指点击
- **环形进度**：4px 宽度，半透明背景
- **网格布局**：3 列网格，自适应屏幕宽度
- **点击反馈**：点击时有缩放动画效果
- **进度颜色**：不同状态使用不同颜色区分

### 2.9 基于 Factorio 的科技系统

#### 2.7.1 科技包系统

```typescript
// 基于Factorio 1.1.107的科技包系统
interface SciencePack {
  id: string;
  name: string;
  color: string;
  complexity: number; // 制作复杂度
  time: number; // 制作时间
  cost: { [itemId: string]: number };
}

const sciencePacks: { [id: string]: SciencePack } = {
  "automation-science-pack": {
    id: "automation-science-pack",
    name: "自动化科技包",
    color: "#EF4444",
    complexity: 1,
    time: 5,
    cost: { "copper-plate": 1, "iron-gear-wheel": 1 },
  },

  "logistic-science-pack": {
    id: "logistic-science-pack",
    name: "物流科技包",
    color: "#22C55E",
    complexity: 2,
    time: 6,
    cost: { "transport-belt": 1, inserter: 1 },
  },

  "military-science-pack": {
    id: "military-science-pack",
    name: "军事科技包",
    color: "#8B5CF6",
    complexity: 3,
    time: 10,
    cost: { "piercing-rounds-magazine": 1, grenade: 1, wall: 2 },
  },

  "chemical-science-pack": {
    id: "chemical-science-pack",
    name: "化学科技包",
    color: "#06B6D4",
    complexity: 4,
    time: 24,
    cost: { sulfur: 1, "advanced-circuit": 3, "engine-unit": 2 },
  },

  "production-science-pack": {
    id: "production-science-pack",
    name: "生产科技包",
    color: "#F59E0B",
    complexity: 5,
    time: 21,
    cost: { "electric-furnace": 1, "productivity-module": 1 },
  },

  "utility-science-pack": {
    id: "utility-science-pack",
    name: "实用科技包",
    color: "#10B981",
    complexity: 6,
    time: 21,
    cost: {
      "flying-robot-frame": 1,
      "low-density-structure": 3,
      "processing-unit": 2,
    },
  },

  "space-science-pack": {
    id: "space-science-pack",
    name: "太空科技包",
    color: "#6366F1",
    complexity: 7,
    time: 2000,
    cost: { satellite: 1 }, // 需要发射火箭
  },
};
```

#### 2.7.2 科技数据结构

```typescript
// 基于Factorio的科技结构
interface Technology {
  id: string;
  name: string;
  category: "technology";
  row: number;
  time: number;
  count: number; // 研究所需科技包数量
  producers: ["lab"]; // 只能由实验室研究
  in: { [sciencePackId: string]: number }; // 科技包需求
  out: { [techId: string]: number };
  isTechnology: true;
  prerequisites?: string[]; // 前置科技
  icon?: string; // 图标
  iconText?: string; // 等级文本
}

// 示例科技数据
const technologyExamples: Technology[] = [
  {
    id: "automation",
    name: "Automation",
    category: "technology",
    row: 0,
    time: 15,
    count: 10,
    producers: ["lab"],
    in: { "automation-science-pack": 1 },
    out: { automation: 1 },
    isTechnology: true,
  },

  {
    id: "steel-processing",
    name: "Steel processing",
    category: "technology",
    row: 2,
    time: 5,
    count: 50,
    producers: ["lab"],
    in: { "automation-science-pack": 1 },
    out: { "steel-processing": 1 },
    isTechnology: true,
  },

  {
    id: "logistics-3",
    name: "Logistics 3",
    category: "technology",
    row: 4,
    time: 30,
    count: 200,
    producers: ["lab"],
    in: {
      "automation-science-pack": 1,
      "logistic-science-pack": 1,
      "chemical-science-pack": 1,
    },
    out: { "logistics-3": 1 },
    isTechnology: true,
    prerequisites: ["logistics-2"],
  },
];
```

#### 2.7.3 科技树管理

```typescript
// 科技研究进度管理
interface ResearchProgress {
  techId: string;
  unlocked: boolean; // 是否已解锁
  researched: boolean; // 是否已研究完成
  progress: number; // 研究进度 (0-1)
  currentSciencePacks: { [packId: string]: number }; // 当前投入的科技包
  estimatedTime: number; // 预计完成时间
  isResearching: boolean; // 是否正在研究中
}

// 科技解锁系统
interface TechnologyUnlockSystem {
  unlockedTechnologies: string[]; // 已解锁的科技
  researchedTechnologies: string[]; // 已研究的科技
  availableRecipes: string[]; // 可用的配方
  researchQueue: string[]; // 研究队列
  currentResearch?: ResearchProgress; // 当前研究项目
}
```

### 2.10 库存更新系统

#### 2.8.1 库存精度问题解决方案

在工厂游戏中，库存必须是整数，但生产速率往往不是整数（如 1.5 秒生产 2 个物品，每秒产量为 1.33 个）。采用**累积小数方案**处理此问题。

```typescript
// 生产累积器 - 处理小数产量问题
interface ProductionAccumulator {
  itemId: string; // 物品ID
  accumulatedAmount: number; // 累积的小数部分
  lastUpdateTime: number; // 上次更新时间
  productionRate: number; // 每秒产量
  recipeTime: number; // 配方时间
  outputAmount: number; // 配方输出数量
}

// 库存管理器
class InventoryManager {
  // 更新生产累积器
  updateProductionAccumulator(
    accumulator: ProductionAccumulator,
    currentTime: number
  ): { inventoryChange: number; displayRate: number } {
    const timeDiff = currentTime - accumulator.lastUpdateTime;
    const theoreticalProduction = accumulator.productionRate * timeDiff;

    // 累积小数部分
    accumulator.accumulatedAmount += theoreticalProduction;

    // 计算整数部分
    const integerPart = Math.floor(accumulator.accumulatedAmount);
    const fractionalPart = accumulator.accumulatedAmount - integerPart;

    // 更新累积值
    accumulator.accumulatedAmount = fractionalPart;
    accumulator.lastUpdateTime = currentTime;

    return {
      inventoryChange: integerPart,
      displayRate: accumulator.productionRate,
    };
  }

  // 计算生产速率
  calculateProductionRate(
    recipe: Recipe,
    equipment: EquipmentInstance
  ): number {
    const baseRate = recipe.out[recipe.id] / recipe.time; // 基础速率
    const efficiency = equipment.efficiency || 1.0;
    const workingFactor = equipment.working ? 1.0 : 0.0;

    return baseRate * efficiency * workingFactor;
  }
}
```

#### 2.8.2 多设备生产处理

```typescript
// 处理多个设备生产同一物品
class MultiEquipmentProduction {
  private accumulators: Map<string, ProductionAccumulator> = new Map();

  // 更新所有设备的生产
  updateAllEquipment(currentTime: number): Map<string, number> {
    const inventoryChanges = new Map<string, number>();

    for (const [itemId, accumulator] of this.accumulators) {
      const result = this.updateProductionAccumulator(accumulator, currentTime);

      if (result.inventoryChange > 0) {
        const currentChange = inventoryChanges.get(itemId) || 0;
        inventoryChanges.set(itemId, currentChange + result.inventoryChange);
      }
    }

    return inventoryChanges;
  }

  // 添加生产设备
  addProductionEquipment(
    itemId: string,
    recipe: Recipe,
    equipment: EquipmentInstance
  ) {
    const existing = this.accumulators.get(itemId);
    const newRate = this.calculateProductionRate(recipe, equipment);

    if (existing) {
      // 合并生产速率
      existing.productionRate += newRate;
    } else {
      // 创建新的累积器
      this.accumulators.set(itemId, {
        itemId,
        accumulatedAmount: 0,
        lastUpdateTime: Date.now(),
        productionRate: newRate,
        recipeTime: recipe.time,
        outputAmount: Object.values(recipe.out)[0],
      });
    }
  }
}
```

#### 2.7.3 显示处理方案

```typescript
// 显示逻辑 - 处理非整数产量
class DisplayManager {
  // 格式化产量显示
  formatProductionRate(rate: number): string {
    if (Number.isInteger(rate)) {
      return `${rate}/秒`;
    } else {
      // 显示为分数形式
      const [numerator, denominator] = this.simplifyFraction(rate);
      return `${numerator}/${denominator}秒`;
    }
  }

  // 简化分数
  simplifyFraction(decimal: number): [number, number] {
    // 示例：1.33 -> 4/3
    const tolerance = 0.001;
    let denominator = 1;

    while (
      Math.abs(decimal * denominator - Math.round(decimal * denominator)) >
      tolerance
    ) {
      denominator++;
    }

    return [Math.round(decimal * denominator), denominator];
  }

  // 显示示例
  displayProductionInfo(accumulator: ProductionAccumulator) {
    const rate = accumulator.productionRate;
    const displayRate = this.formatProductionRate(rate);

    console.log(`产量: ${displayRate}`); // 显示: "产量: 4/3秒"
    console.log(`累积: ${accumulator.accumulatedAmount.toFixed(3)}`); // 显示累积的小数部分
  }
}
```

#### 2.7.4 性能优化实现

```typescript
// 优化版本 - 批量更新
class OptimizedInventoryManager {
  private updateInterval = 100; // 100ms更新一次
  private lastBatchUpdate = 0;

  // 批量更新所有生产
  batchUpdate(currentTime: number) {
    if (currentTime - this.lastBatchUpdate < this.updateInterval) {
      return; // 跳过更新
    }

    // 执行批量更新
    this.updateAllProduction(currentTime);
    this.lastBatchUpdate = currentTime;
  }

  // 使用对象池减少内存分配
  private accumulatorPool: ProductionAccumulator[] = [];

  getAccumulator(): ProductionAccumulator {
    return this.accumulatorPool.pop() || this.createNewAccumulator();
  }

  recycleAccumulator(accumulator: ProductionAccumulator) {
    this.accumulatorPool.push(accumulator);
  }
}
```

#### 2.7.5 实际应用示例

```typescript
// 游戏主循环中的使用
class GameLoop {
  private inventoryManager = new InventoryManager();
  private lastUpdateTime = Date.now();

  update() {
    const currentTime = Date.now();
    const deltaTime = currentTime - this.lastUpdateTime;

    // 更新所有生产设备
    const inventoryChanges =
      this.inventoryManager.updateAllProduction(currentTime);

    // 应用库存变化
    for (const [itemId, change] of inventoryChanges) {
      this.gameState.resources[itemId] += change;
    }

    this.lastUpdateTime = currentTime;
  }
}

// 使用示例
const game = new GameLoop();

// 添加铁板生产 (1.5秒生产2个)
game.inventoryManager.addProduction(
  "iron-plate",
  {
    time: 1.5,
    out: { "iron-plate": 2 },
  },
  equipment
);

// 游戏循环中自动处理小数累积
setInterval(() => game.update(), 100); // 100ms更新一次
```

**优势总结：**

- ✅ **精确性**：保持库存为整数，同时准确反映生产进度
- ✅ **性能**：批量更新，减少计算开销
- ✅ **显示**：支持非整数产量的友好显示
- ✅ **扩展性**：支持多设备、多配方、多物品
- ✅ **兼容性**：与 Factorio 原版逻辑一致

### 2.11 本地存储系统

#### 2.9.1 存储架构设计

```
本地存储架构：
├── 主存储：SQLite数据库
│   ├── game_state表：游戏核心状态
│   ├── save_slots表：多存档支持
│   └── user_settings表：用户配置
│
├── 配置存储：SharedPreferences/AsyncStorage
│   ├── 界面设置
│   ├── 游戏偏好
│   └── 最后选择的存档
│
└── 缓存存储：内存缓存
    ├── 当前游戏状态
    ├── 计算结果缓存
    └── 界面状态缓存
```

#### 2.9.2 数据持久化策略

```
自动保存机制：
├── 频率控制：每30秒自动保存
├── 事件触发：重要操作后立即保存
├── 应用生命周期：
│   ├── 进入后台：立即保存
│   ├── 应用退出：强制保存
│   └── 崩溃恢复：定期备份
└── 数据完整性：
    ├── 保存前验证数据有效性
    ├── 保存后校验数据完整性
    └── 损坏时自动恢复机制
```

#### 2.9.3 多存档系统

```
存档管理功能：
├── 存档槽位：支持最多5个存档
├── 存档信息：
│   ├── 存档名称（用户自定义）
│   ├── 游戏进度（等级、时间）
│   ├── 创建时间和最后修改时间
│   └── 存档预览图（可选）
├── 存档操作：
│   ├── 创建新存档
│   ├── 加载指定存档
│   ├── 删除存档
│   ├── 重命名存档
│   └── 导出/导入存档文件
└── 存档保护：
    ├── 删除前二次确认
    ├── 重要存档锁定保护
    └── 意外删除恢复机制
```

### 2.12 生产链可视化系统（新增）

#### 2.10.1 生产链视图设计

**注：生产链视图现已整合到生产Tab的顶部分类标签中**

```
生产链视图（生产Tab内）：
┌─────────────────────────────────┐
│ 视图模式: [层级图] [流程图]     │ ← 视图切换
├─────────────────────────────────┤
│     铁矿石 ──→ 熔炉 ──→ 铁板    │
│       ↓                   ↓      │
│     煤炭               铁齿轮    │
│                          ↓       │
│                      传送带      │
└─────────────────────────────────┘
```

#### 2.10.2 生产链功能规范

```typescript
interface ProductionChainSystem {
  // 视图模式
  viewModes: {
    hierarchical: {
      name: '层级视图',
      layout: 'left-to-right',
      groupByTier: true,
      showDependencies: true
    },
    flow: {
      name: '流程视图',
      layout: 'custom',
      showRates: true,
      animateFlow: true
    },
    simplified: {
      name: '简化视图',
      showOnlyActive: true,
      collapseGroups: true
    }
  },
  
  // 节点交互
  nodeInteractions: {
    tap: 'showDetails',
    doubleTap: 'navigateToItem',
    longPress: 'showContextMenu',
    pinch: 'zoom'
  },
  
  // 实时数据展示
  realtimeData: {
    productionRate: true,
    bottlenecks: true,
    efficiency: true,
    stockLevels: true
  },
  
  // 优化建议
  optimization: {
    autoDetectBottlenecks: true,
    suggestImprovements: true,
    highlightInefficiencies: true
  }
}
```

### 2.13 统计分析系统（新增）

#### 2.11.1 统计分析界面

**注：统计分析现已成为独立的底部Tab**

```
统计Tab界面布局：
┌─────────────────────────────────┐
│ 📊 生产统计         [时间范围▼] │
├─────────────────────────────────┤
│ 总体效率: 85%  瓶颈: 铁板生产   │
├─────────────────────────────────┤
│ [生产趋势图表]                  │
│                                 │
├─────────────────────────────────┤
│ 🏆 生产排行                     │
│ 1. 铁板 1.2K/分钟               │
│ 2. 铜板 800/分钟                │
│ 3. 齿轮 600/分钟                │
├─────────────────────────────────┤
│ 💡 优化建议                     │
│ • 增加2台熔炉提升铁板产量       │
│ • 铜线库存过高，减少生产        │
└─────────────────────────────────┘
```

#### 2.11.2 统计功能规范

```typescript
interface ProductionAnalytics {
  // 核心指标
  metrics: {
    overall: {
      efficiency: number,         // 总体效率百分比
      utilizationRate: number,    // 设备利用率
      wasteRate: number,         // 浪费率
      bottlenecks: string[]      // 瓶颈列表
    },
    
    // 时间维度分析
    timeSeries: {
      intervals: ['1小时', '6小时', '24小时', '7天'],
      data: {
        production: number[],
        consumption: number[],
        efficiency: number[]
      }
    },
    
    // 物品排行榜
    rankings: {
      mostProduced: ItemRank[],
      mostConsumed: ItemRank[],
      mostStored: ItemRank[],
      leastEfficient: ItemRank[]
    }
  },
  
  // 智能分析
  intelligence: {
    // 瓶颈检测
    bottleneckDetection: {
      algorithm: 'flow-analysis',
      threshold: 0.9,
      suggestions: true
    },
    
    // 效率分析
    efficiencyAnalysis: {
      compareToOptimal: true,
      identifyWaste: true,
      suggestLayout: true
    },
    
    // 预测分析
    prediction: {
      shortageWarning: true,
      overflowPrediction: true,
      maintenanceSchedule: true
    }
  },
  
  // 可视化组件
  visualizations: {
    charts: {
      productionTrend: 'line',
      inventoryDistribution: 'pie',
      efficiencyHeatmap: 'heatmap',
      flowSankey: 'sankey'
    },
    
    // 实时仪表盘
    dashboard: {
      widgets: [
        'efficiency-gauge',
        'production-rate',
        'alert-panel',
        'quick-stats'
      ]
    }
  }
}

// 优化建议生成器
class OptimizationAdvisor {
  generateSuggestions(): Suggestion[] {
    const suggestions: Suggestion[] = [];
    
    // 检测并建议
    this.checkProductionBalance();
    this.checkStorageUtilization();
    this.checkEquipmentEfficiency();
    this.checkResourceFlow();
    
    return this.prioritizeSuggestions(suggestions);
  }
}
```

### 2.14 改进的新手引导系统（新增）

#### 2.12.1 渐进式引导设计

```typescript
interface ProgressiveTutorial {
  // 分阶段内容解锁
  stages: {
    // 第一阶段：基础概念
    beginner: {
      duration: '0-30分钟',
      unlockedCategories: ['中间产品'],
      unlockedItems: ['iron-ore', 'copper-ore', 'iron-plate', 'copper-plate'],
      features: ['手动开采', '手动制作', '物品查看'],
      
      guidedTasks: [
        {
          id: 'first-mining',
          title: '第一次开采',
          objective: '手动开采10个铁矿石',
          reward: { coal: 20 },
          hints: ['点击铁矿石', '选择手动开采']
        },
        {
          id: 'first-smelting',
          title: '冶炼入门',
          objective: '制作5个铁板',
          reward: { 'stone-furnace': 1 },
          hints: ['铁矿石需要冶炼', '建造熔炉']
        }
      ]
    },
    
    // 第二阶段：自动化入门
    intermediate: {
      duration: '30分钟-2小时',
      additionalCategories: ['生产系统'],
      additionalItems: ['burner-mining-drill', 'stone-furnace', 'iron-gear-wheel'],
      features: ['设备建造', '自动生产', '燃料管理'],
      
      guidedTasks: [
        {
          id: 'first-automation',
          title: '自动化开始',
          objective: '建造并运行采矿机',
          reward: { coal: 50 },
          tutorial: 'interactive' // 交互式教程
        }
      ]
    },
    
    // 第三阶段：完整体验
    advanced: {
      duration: '2小时+',
      allContentUnlocked: true,
      features: ['科技研发', '生产链', '效率优化'],
      
      challenges: [
        '建立完整的铁板生产线',
        '研发第一个科技',
        '达到100/分钟的生产效率'
      ]
    }
  }
}
```

#### 2.12.2 交互式教程系统

```typescript
interface InteractiveTutorial {
  // 生产链教程
  productionChainTutorial: {
    type: 'interactive',
    steps: [
      {
        id: 'show-iron-ore',
        action: 'highlight',
        target: 'iron-ore',
        text: '这是铁矿石，最基础的原材料',
        position: 'bottom'
      },
      {
        id: 'draw-connection',
        action: 'animate-arrow',
        from: 'iron-ore',
        to: 'stone-furnace',
        text: '铁矿石需要在熔炉中冶炼'
      },
      {
        id: 'show-result',
        action: 'highlight',
        target: 'iron-plate',
        text: '冶炼后得到铁板，这是制作其他物品的基础'
      },
      {
        id: 'try-yourself',
        action: 'guided-action',
        task: '现在试着自己建造一个熔炉',
        validation: 'check-furnace-built'
      }
    ]
  },
  
  // 概念解释器
  conceptExplainer: {
    triggers: ['first-time-see', 'help-button', 'confusion-detected'],
    
    explanations: {
      'production-rate': {
        title: '什么是生产速率？',
        content: '生产速率表示每秒生产的物品数量...',
        example: '1.5/秒 表示每秒生产1.5个',
        visual: 'animated-demo'
      },
      
      'supply-chain': {
        title: '理解供应链',
        content: '供应链是物品之间的生产依赖关系...',
        interactive: true,
        practice: 'build-simple-chain'
      }
    }
  },
  
  // 智能提示系统
  smartHints: {
    contextual: true,
    triggers: {
      'low-resources': '资源不足时提示如何获取',
      'idle-equipment': '设备闲置时提示检查原因',
      'inefficient': '效率低时提示优化方法'
    },
    
    frequency: 'adaptive', // 根据玩家水平调整
    dismissible: true
  }
}
```

### 2.15 离线收益系统（新增）

#### 2.13.1 离线收益机制

```typescript
interface OfflineProgressSystem {
  // 离线收益设置
  settings: {
    maxOfflineTime: 24 * 3600,     // 最多24小时离线收益
    minOfflineTime: 60,             // 最少1分钟才计算离线收益
    
    // 效率递减机制
    efficiencyDecay: {
      enabled: true,
      stages: [
        { duration: 3600, efficiency: 1.0 },    // 第1小时100%
        { duration: 3600, efficiency: 0.8 },    // 第2小时80%
        { duration: 7200, efficiency: 0.5 },    // 3-4小时50%
        { duration: 14400, efficiency: 0.3 },   // 5-8小时30%
        { duration: 57600, efficiency: 0.1 }    // 9-24小时10%
      ]
    }
  },
  
  // 特殊规则
  specialRules: {
    fuelDepletion: {
      enabled: true,
      // 燃料设备按实际燃料量计算运行时间
      calculateRuntime: (fuelAmount: number, consumptionRate: number) => {
        return fuelAmount / consumptionRate;
      }
    },
    
    storageLimit: {
      enabled: true,
      // 达到存储上限后停止生产
      stopWhenFull: true
    },
    
    maintenancePenalty: {
      enabled: true,
      // 离线期间维护需求增加
      penaltyRate: 0.01 // 每小时1%效率损失
    }
  }
}
```

#### 2.13.2 离线收益报告

```
离线收益报告界面：
┌─────────────────────────────────┐
│ 🌙 离线收益报告                 │
│ 离线时长: 3小时24分钟            │
├─────────────────────────────────┤
│ 📦 生产统计                     │
│ 铁板: +2,450                    │
│ 铜板: +1,830                    │
│ 齿轮: +920                      │
│ [查看全部...]                   │
├─────────────────────────────────┤
│ ⚡ 消耗统计                     │
│ 煤炭: -450                      │
│ 铁矿石: -2,450                  │
├─────────────────────────────────┤
│ 📢 重要事件                     │
│ • 3个存储已满，生产暂停         │
│ • 5台设备燃料耗尽              │
│ • 解锁新科技: 物流2            │
├─────────────────────────────────┤
│ [收取全部] [观看广告双倍]       │
└─────────────────────────────────┘
```

#### 2.13.3 离线计算实现

```typescript
class OfflineProgressCalculator {
  // 计算离线收益
  calculateOfflineProgress(offlineSeconds: number): OfflineProgress {
    const progress = new OfflineProgress();
    
    // 限制最大离线时间
    const effectiveTime = Math.min(offlineSeconds, this.settings.maxOfflineTime);
    
    // 分阶段计算效率
    let currentTime = 0;
    for (const stage of this.settings.efficiencyDecay.stages) {
      const stageTime = Math.min(stage.duration, effectiveTime - currentTime);
      if (stageTime <= 0) break;
      
      // 计算该阶段的生产
      this.calculateStageProduction(progress, stageTime, stage.efficiency);
      currentTime += stageTime;
    }
    
    // 应用特殊规则
    this.applyFuelDepletion(progress);
    this.applyStorageLimits(progress);
    this.applyMaintenancePenalty(progress, effectiveTime);
    
    return progress;
  }
  
  // 生成离线报告
  generateOfflineReport(progress: OfflineProgress): OfflineReport {
    return {
      duration: this.formatDuration(progress.offlineTime),
      production: this.summarizeProduction(progress),
      consumption: this.summarizeConsumption(progress),
      events: this.collectImportantEvents(progress),
      suggestions: this.generateSuggestions(progress)
    };
  }
}
```

## 3. 用户界面设计规范

### 3.1 整体视觉系统

#### 3.1.1 主界面布局

```
主界面结构：
┌─────────────────────────────────┐ ← 状态栏 (48px)
│ 异星工厂  12:34  💰100 💎10 [⏸️] │
├─────────────────────────────────┤ ← 动态顶部区域
│ [根据当前Tab显示不同内容]        │
├─────────────────────────────────┤ ← 主要内容区域
│                                 │
│        [Tab对应的主要内容]       │
│                                 │
│                    🔧3 ←浮动气泡│
├─────────────────────────────────┤ ← 底部Tab栏 (56px)
│  🏭     🧪     📊     ⚙️    🎯  │
│ 基地   科技   统计   设置  任务  │
└─────────────────────────────────┘
```

#### 3.1.2 底部Tab导航系统（新增）

**Tab结构设计：**
```typescript
interface BottomTabNavigation {
  tabs: [
    {
      id: 'production',
      name: '生产',
      icon: '🏭',
      default: true,
      hasTopTabs: true, // 有顶部分类标签
      badge: null
    },
    {
      id: 'facilities',
      name: '设施',
      icon: '🏗️',
      hasTopTabs: true, // 有设施分类
      badge: 'alert' // 显示需要维护的设施数
    },
    {
      id: 'technology',
      name: '科技',
      icon: '🧪',
      hasTopTabs: false,
      badge: 'researchProgress' // 显示研究进度
    },
    {
      id: 'statistics',
      name: '统计',
      icon: '📊',
      hasTopTabs: false,
      badge: null
    },
    {
      id: 'settings',
      name: '设置',
      icon: '⚙️',
      hasTopTabs: false,
      badge: null
    },
    {
      id: 'missions',
      name: '任务',
      icon: '🎯',
      hasTopTabs: false,
      badge: 'new' // 新任务提示
    }
  ]
}
```

**各Tab详细设计：**

##### 1. 生产Tab（默认）
```
生产Tab布局：
┌─────────────────────────────────┐
│ 🔍 搜索物品、配方或用途...       │ ← 搜索栏
├─────────────────────────────────┤
│ [物流][原料][中间][产品][流体]  │ ← 物品分类标签
├─────────────────────────────────┤
│                                 │
│        4×N 物品网格             │ ← 库存物品展示
│                                 │
└─────────────────────────────────┘
```

**功能说明：**
- 库存物品查看和管理
- 物品制作和生产监控
- 原材料和产品管理
- 快速制作入口
- 生产链查看

##### 2. 设施Tab（新增）
```
设施Tab布局：
┌─────────────────────────────────┐
│ ⚡100MW/150MW  🔬3/3  🛡️防御正常│ ← 设施状态概览
├─────────────────────────────────┤
│ [电力][生产][研究][防御][物流]  │ ← 设施分类
├─────────────────────────────────┤
│ 🏭 电力设施                     │
│ ┌─────────────────────────────┐ │
│ │ 蒸汽发电机 ×5  ⚡50MW       │ │
│ │ ●●●●● 5/5运行 燃料:85%      │ │
│ │ [管理] [添加]               │ │
│ ├─────────────────────────────┤ │
│ │ 太阳能板 ×20  ⚡10MW        │ │
│ │ ☀️ 白天运行中               │ │
│ │ [管理] [添加]               │ │
│ └─────────────────────────────┘ │
└─────────────────────────────────┘
```

**设施分类：**
- **电力设施**：蒸汽发电机、太阳能板、蓄电池、核电站
- **生产设施**：采矿机、熔炉、装配机、化工厂、炼油厂
- **研究设施**：实验室
- **防御设施**：炮台、激光塔、火焰塔、石墙、雷达
- **物流设施**：箱子、储液罐、机械臂、传送带

##### 3. 科技Tab
```
科技Tab布局：
┌─────────────────────────────────┐
│ 当前研究: 自动化2 (65%) ⏱️2:45  │ ← 研究进度条
├─────────────────────────────────┤
│ 研究队列: 物流2 → 军事科技      │
├─────────────────────────────────┤
│   [科技树可视化]                │
│   ● 已解锁                      │
│   ◐ 研究中                      │
│   ○ 可研究                      │
│   ⊗ 未解锁                      │
└─────────────────────────────────┘
```

**功能说明：**
- 科技树展示
- 研究进度管理
- 研究队列设置
- 科技详情查看

##### 4. 统计Tab
```
统计Tab布局：
┌─────────────────────────────────┐
│ 时间范围: [1h][6h][24h][7d] ▼   │
├─────────────────────────────────┤
│ 📈 总效率: 85% ↑2.3%            │
│ [效率趋势图表]                  │
├─────────────────────────────────┤
│ 🏆 生产排行                     │
│ 1. 铁板 1.2K/分钟               │
│ 2. 铜板 800/分钟                │
├─────────────────────────────────┤
│ 💡 优化建议                     │
│ • 增加2台熔炉提升铁板产量       │
└─────────────────────────────────┘
```

**功能说明：**
- 生产数据分析
- 效率指标展示
- 瓶颈检测
- 优化建议

##### 5. 设置Tab
```
设置Tab布局：
┌─────────────────────────────────┐
│ ⚙️ 游戏设置                     │
├─────────────────────────────────┤
│ 🎮 游戏选项                     │
│ ├─ 自动保存 [开启]              │
│ └─ 离线收益 [开启]              │
├─────────────────────────────────┤
│ 🖼️ 显示设置                     │
│ ├─ 生产速率单位 [自动▼]         │
│ └─ 数字格式 [简化▼]             │
├─────────────────────────────────┤
│ 🔊 音效设置                     │
│ ├─ 主音量 ████████── 80%        │
│ └─ 振动反馈 [开启]              │
├─────────────────────────────────┤
│ 💾 存档管理                     │
│ └─ [管理存档]                   │
└─────────────────────────────────┘
```

##### 6. 任务Tab
```
任务Tab布局：
┌─────────────────────────────────┐
│ 🎯 每日任务 (2/3)               │
├─────────────────────────────────┤
│ ✓ 生产100个铁板                 │
│ ◐ 建造5台设备 (3/5)             │
│ ○ 解锁一项科技                  │
├─────────────────────────────────┤
│ 🏆 本周挑战                     │
│ 极限效率：最少设备挑战          │
│ 进度: 85/100 产量               │
│ 排名: 第3名                     │
├─────────────────────────────────┤
│ 🌟 成就进度                     │
│ [查看全部成就]                  │
└─────────────────────────────────┘
```

#### 3.1.3 响应式设计规范

```
屏幕适配规范：
├── 最小宽度：320px (iPhone SE)
├── 最大宽度：480px (大屏手机)
├── 安全区域：适配刘海屏和圆角
├── 触摸目标：最小44×44px
└── 字体缩放：支持系统字体大小设置
```

### 3.2 色彩设计系统

#### 3.2.1 基于 Factorio 的主色调定义

```
颜色规范：
├── 主色调：
│   ├── 主色：#2563EB (蓝色) - 主要按钮、链接
│   ├── 成功：#10B981 (绿色) - 成功状态、运行中
│   ├── 警告：#F59E0B (橙色) - 警告状态、燃料相关
│   ├── 错误：#EF4444 (红色) - 错误状态、停止状态
│   └── 中性：#6B7280 (灰色) - 文本、边框
│
├── 基于Factorio的分类色彩：
│   ├── 物流系统 (Logistics)：#22C55E (绿色系) - 传送带、机械臂、箱子
│   ├── 生产系统 (Production)：#EAB308 (黄色系) - 熔炉、装配机、采掘机
│   ├── 中间产品 (Intermediate)：#3B82F6 (蓝色系) - 铁板、铜板、电路板
│   ├── 战斗系统 (Combat)：#EF4444 (红色系) - 武器、弹药、护甲
│   ├── 流体系统 (Fluids)：#06B6D4 (青色系) - 水、油、蒸汽
│   └── 科技系统 (Technology)：#8B5CF6 (紫色系) - 科技包、实验室
│
├── 科技包色彩：
│   ├── 自动化科技包：#EF4444 (红色)
│   ├── 物流科技包：#22C55E (绿色)
│   ├── 军事科技包：#8B5CF6 (紫色)
│   ├── 化学科技包：#06B6D4 (青色)
│   ├── 生产科技包：#F59E0B (橙色)
│   ├── 实用科技包：#10B981 (绿色)
│   └── 太空科技包：#6366F1 (靛蓝色)
│
└── 状态色彩：
    ├── 生产中：#10B981 (绿色)
    ├── 停止中：#EF4444 (红色)
    ├── 缺料中：#F59E0B (橙色)
    ├── 维护中：#6B7280 (灰色)
    ├── 研究中：#8B5CF6 (紫色)
    └── 已解锁：#22C55E (绿色)
```

#### 3.2.2 物品图标色彩

```
物品图标颜色映射：
├── 矿物类：棕色到橙色系
├── 金属类：银色到灰色系
├── 机械类：黄色到金色系
├── 电子类：绿色到蓝色系
├── 化工类：蓝色到紫色系
├── 科技类：紫色到粉色系
└── 军事类：红色到深红系
```

### 3.3 字体和排版规范

#### 3.3.1 字体层级系统

```
字体大小规范：
├── 标题文字：18px, 字重700 (页面标题)
├── 副标题：16px, 字重600 (区域标题)
├── 正文文字：14px, 字重400 (主要文本)
├── 辅助文字：12px, 字重400 (辅助信息)
├── 小号文字：10px, 字重400 (状态标签)
└── 数字文字：14px, 字重600 (数值显示)
```

#### 3.3.2 排版间距规范

```
间距系统：
├── 基础间距：4px (最小间距单位)
├── 组件内间距：8px (按钮内边距)
├── 相关元素间距：12px (相关内容间距)
├── 段落间距：16px (段落之间间距)
├── 区域间距：24px (不同区域间距)
└── 页面间距：32px (页面边距)
```

### 3.4 交互设计规范

#### 3.4.1 触摸交互标准

```
交互行为定义：
├── 点击 (Tap)：
│   ├── 物品卡片：打开物品详情
│   ├── 设施按钮：调整设施数量
│   ├── 分类标签：切换物品分类
│   └── 功能按钮：执行对应功能
│
├── 长按 (Long Press)：
│   ├── 物品卡片：快速操作菜单
│   ├── 设施项目：设施详细信息
│   └── 队列任务：任务管理选项
│
└── 滑动 (Swipe)：
    ├── 水平滑动：切换分类标签
    ├── 垂直滑动：滚动物品列表
    └── 制作队列：滑动删除任务
```

#### 3.4.2 动画和过渡效果

```
动画规范：
├── 页面切换：300ms ease-in-out
├── 弹窗出现：200ms ease-out
├── 按钮点击：100ms ease-in
├── 数值变化：150ms ease-out
├── 进度条：实时更新，无动画
└── 状态切换：200ms ease-in-out
```

### 3.5 组件设计规范

#### 3.5.1 按钮组件规范

```
按钮类型定义：
├── 主要按钮：
│   ├── 背景：#2563EB
│   ├── 文字：#FFFFFF
│   ├── 高度：44px
│   ├── 圆角：8px
│   └── 用途：主要操作
│
├── 次要按钮：
│   ├── 背景：透明
│   ├── 边框：1px #2563EB
│   ├── 文字：#2563EB
│   ├── 高度：44px
│   └── 用途：次要操作
│
├── 危险按钮：
│   ├── 背景：#EF4444
│   ├── 文字：#FFFFFF
│   ├── 高度：44px
│   └── 用途：删除等危险操作
│
└── 图标按钮：
    ├── 尺寸：44×44px
    ├── 背景：透明或浅色
    ├── 图标：24×24px
    └── 用途：工具栏操作
```

#### 3.5.2 卡片组件规范

```
卡片设计规范：
├── 背景色：#FFFFFF
├── 边框：1px #E5E7EB
├── 圆角：8px
├── 阴影：0 1px 3px rgba(0,0,0,0.1)
├── 内边距：12px
├── 悬停效果：阴影加深
└── 点击效果：轻微缩放
```

#### 3.5.3 进度条组件规范

```
进度条设计：
├── 细进度条：
│   ├── 高度：4px
│   ├── 背景：#E5E7EB
│   ├── 前景：根据类型选择
│   └── 圆角：2px
│
└── 粗进度条：
    ├── 高度：8px
    ├── 背景：#E5E7EB
    ├── 前景：根据类型选择
    └── 圆角：4px
```

## 4. 游戏机制详解

### 4.1 物流系统对生产的影响

#### 4.1.1 生产效率计算

物流系统是游戏的核心机制，直接影响生产效率：

```
实际产能计算流程：
1. 计算设施的基础产能（设施数量 × 单台产能）
2. 计算输入物流能力（所有输入传送带+机械臂的总运力）
3. 计算输出物流能力（所有输出传送带+机械臂的总运力）
4. 实际产能 = Min(基础产能, 输入物流能力, 输出物流能力)
```

#### 4.1.2 物流瓶颈类型

- **输入瓶颈**：原料供应速度 < 设施消耗速度
- **输出瓶颈**：产品运出速度 < 设施生产速度
- **无瓶颈**：物流能力 ≥ 设施需求

#### 4.1.3 优化策略

1. **成本效益分析**：
   - 传送带：高运力、高成本
   - 机械臂：低运力、低成本
   - 混合方案：平衡成本与效率

2. **升级时机**：
   - 效率 < 70%：急需升级
   - 效率 70-90%：建议升级
   - 效率 > 90%：运行良好

3. **配置技巧**：
   - 优先使用传送带处理大批量运输
   - 使用机械臂进行精确控制和小批量补充
   - 根据设施位置和产能需求选择合适的组合

## 5. 技术实现规范

### 5.1 技术架构选型

#### 5.1.1 前端技术栈

```
推荐技术方案：
├── 主框架：React Native
│   ├── 优势：跨平台、生态成熟、性能优秀
│   ├── 版本：React Native 0.72+
│   └── 语言：TypeScript
│
├── 状态管理：Redux Toolkit
│   ├── 全局状态：游戏核心数据
│   ├── 本地状态：React useState
│   └── 持久化：Redux Persist
│
├── 导航：React Navigation 6
│   ├── 页面导航：Stack Navigator
│   ├── 标签导航：Tab Navigator
│   └── 弹窗导航：Modal Navigator
│
└── UI组件：
    ├── 基础组件：React Native内置
    ├── 图标库：React Native Vector Icons
    └── 动画库：React Native Reanimated
```

#### 4.1.2 数据存储技术

```
存储技术选型：
├── 游戏数据：SQLite
│   ├── 库：react-native-sqlite-storage
│   ├── 优势：结构化存储、查询性能好
│   └── 用途：游戏状态、存档、统计数据
│
├── 配置数据：AsyncStorage
│   ├── 库：@react-native-async-storage/async-storage
│   ├── 优势：简单易用、性能好
│   └── 用途：用户设置、偏好配置
│
├── 缓存数据：内存
│   ├── 实现：JavaScript对象
│   ├── 优势：访问速度最快
│   └── 用途：当前游戏状态、计算结果
│
└── 临时数据：文件系统
    ├── 库：react-native-fs
    ├── 优势：大容量、可导出
    └── 用途：存档备份、日志文件
```

### 4.2 数据结构设计

#### 4.2.1 基于 Factorio 的游戏状态数据结构

```typescript
// 基于Factorio 1.1.107数据的游戏状态结构
interface GameState {
  // 版本信息
  version: {
    base: string; // Factorio版本
    DataRawJson: string; // 数据格式版本
  };

  // 分类定义
  categories: Category[]; // 基于Factorio的分类
  icons: Icon[]; // 图标定义
  items: Item[]; // 物品定义
  recipes: Recipe[]; // 配方定义
  technologies: Technology[]; // 科技定义

  // 玩家信息
  player: {
    id: string;
    level: number;
    experience: number;
    playtime: number;
    currencies: {
      gold: number;
      crystals: number;
    };
  };

  // 资源库存 (基于Factorio物品ID)
  resources: {
    [itemId: string]: number;
  };

  // 设备实例管理
  equipment: EquipmentManagement;

  // 科技研发系统
  research: {
    unlockedTechnologies: string[]; // 已解锁的科技
    researchedTechnologies: string[]; // 已研究的科技
    availableRecipes: string[]; // 可用的配方
    researchQueue: string[]; // 研究队列
    currentResearch?: ResearchProgress; // 当前研究项目
  };

  // 制作队列
  craftingQueue: CraftingTask[];

  // 游戏设置
  settings: {
    autoSave: boolean;
    soundEnabled: boolean;
    vibrationEnabled: boolean;
    selectedCategory: string;
  };

  // 生产率模块限制
  limitations: {
    "productivity-module": string[]; // 不能使用生产率模块的配方
  };

  // 元数据
  metadata: {
    version: string;
    lastSaved: number;
    totalPlaytime: number;
    factorioVersion: string; // 对应的Factorio版本
  };
}

// 物品数据结构 (基于Factorio)
interface Item {
  id: string;
  name: string;
  category: string;
  stack: number; // 堆叠数量
  row: number; // 科技树行位置

  // 特殊属性
  container?: { size: number }; // 容器容量
  belt?: { speed: number }; // 传送带速度
  storageTank?: { capacity: number }; // 储罐容量
  fuel?: { value: number }; // 燃料值
}

// 分类定义 (基于Factorio)
interface Category {
  id: string;
  name: string;
  icon?: string;
}

// 图标定义 (基于Factorio)
interface Icon {
  id: string;
  position: string;
  color: string;
}
```

#### 4.2.2 设备实例数据结构

```typescript
interface EquipmentInstance {
  id: string;
  type: string;
  level: number;
  efficiency: number;
  working: boolean;

  // 燃料设备专有
  fuel?: number;
  maxFuel?: number;
  fuelType?: string;

  // 电力设备专有
  powerConnected?: boolean;
  powerConsumption?: number;

  // 模块插槽
  modules?: {
    [slotIndex: number]: ModuleInstance;
  };

  // 状态信息
  lastMaintenance?: number;
  totalRuntime?: number;
  totalProduction?: number;
}
```

#### 4.2.3 制作任务数据结构

```typescript
interface CraftingTask {
  id: string;
  type: "mining" | "crafting";
  itemId: string;
  quantity: number;
  progress: number;
  totalTime: number;

  // 制作任务专有
  recipeId?: string;
  materialsConsumed?: boolean;

  // 开采任务专有
  miningMethod?: "manual" | "automatic";

  // 状态信息
  createdAt: number;
  startedAt?: number;
  estimatedCompletion?: number;
}
```

### 4.3 性能优化策略

#### 4.3.1 渲染性能优化

```
渲染优化措施：
├── 虚拟化滚动：
│   ├── 使用FlatList代替ScrollView
│   ├── 设置合理的初始渲染数量
│   └── 实现windowSize优化
│
├── 图片优化：
│   ├── 使用适当的图片格式和尺寸
│   ├── 实现图片懒加载
│   └── 缓存频繁使用的图片
│
├── 组件优化：
│   ├── 使用React.memo避免无用渲染
│   ├── 使用useMemo缓存计算结果
│   └── 使用useCallback避免函数重新创建
│
└── 状态管理优化：
    ├── 避免过度的状态更新
    ├── 使用批量更新减少渲染次数
    └── 合理拆分状态避免全局更新
```

#### 4.3.2 内存管理优化

```
内存优化策略：
├── 数据结构优化：
│   ├── 使用合适的数据类型
│   ├── 避免循环引用
│   └── 及时清理不用的数据
│
├── 缓存策略：
│   ├── 设置合理的缓存大小限制
│   ├── 实现LRU缓存淘汰策略
│   └── 定期清理过期缓存
│
├── 对象池：
│   ├── 重用频繁创建的对象
│   ├── 预分配常用对象
│   └── 减少垃圾回收压力
│
└── 监控工具：
    ├── 集成内存使用监控
    ├── 设置内存泄漏警告
    ├── 定期内存使用报告
    └── 性能瓶颈自动检测
```

#### 4.3.3 游戏循环优化

```
游戏循环性能优化：
├── 频率控制：
│   ├── 主循环：100ms (10fps)
│   ├── UI更新：16.67ms (60fps)
│   ├── 数据保存：30s自动保存
│   └── 统计计算：1s更新一次
│
├── 计算优化：
│   ├── 增量计算：只计算变化的部分
│   ├── 批量处理：合并多个小计算
│   ├── 异步计算：复杂计算放入后台
│   └── 缓存结果：缓存重复计算结果
│
├── 更新策略：
│   ├── 脏标记：标记需要更新的数据
│   ├── 优先级：重要数据优先计算
│   ├── 分帧处理：大任务分多帧完成
│   └── 暂停机制：后台时暂停非必要计算
│
└── 资源管理：
    ├── 对象复用：复用临时计算对象
    ├── 延迟初始化：按需创建计算对象
    ├── 自动垃圾回收：定期清理无用对象
    └── 资源预加载：提前加载常用资源
```

### 4.4 数据持久化实现

#### 4.4.1 SQLite 数据库设计

```sql
-- 游戏存档表
CREATE TABLE save_files (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    game_data TEXT NOT NULL, -- JSON格式的游戏数据
    preview_image BLOB,      -- 存档预览图
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL,
    version TEXT NOT NULL,
    is_active BOOLEAN DEFAULT FALSE
);

-- 用户设置表
CREATE TABLE user_settings (
    key TEXT PRIMARY KEY,
    value TEXT NOT NULL,
    type TEXT NOT NULL -- 'string', 'number', 'boolean', 'json'
);

-- 游戏统计表
CREATE TABLE game_statistics (
    save_id INTEGER,
    stat_name TEXT,
    stat_value REAL,
    recorded_at INTEGER,
    FOREIGN KEY (save_id) REFERENCES save_files(id)
);

-- 成就记录表
CREATE TABLE achievements (
    save_id INTEGER,
    achievement_id TEXT,
    unlocked_at INTEGER,
    progress REAL DEFAULT 0,
    FOREIGN KEY (save_id) REFERENCES save_files(id)
);
```

#### 4.4.2 数据序列化策略

```typescript
// 数据压缩和序列化
class GameDataSerializer {
  // 序列化游戏状态
  static serialize(gameState: GameState): string {
    // 1. 移除冗余数据
    const cleanedState = this.removeRedundantData(gameState);

    // 2. 压缩数据结构
    const compressedState = this.compressData(cleanedState);

    // 3. JSON序列化
    const serialized = JSON.stringify(compressedState);

    // 4. 可选的进一步压缩
    return this.gzipCompress(serialized);
  }

  // 反序列化游戏状态
  static deserialize(data: string): GameState {
    // 1. 解压缩
    const decompressed = this.gzipDecompress(data);

    // 2. JSON解析
    const parsed = JSON.parse(decompressed);

    // 3. 数据解压缩
    const expanded = this.expandData(parsed);

    // 4. 数据验证和修复
    return this.validateAndRepair(expanded);
  }

  // 版本迁移
  static migrate(data: any, fromVersion: string, toVersion: string): GameState {
    const migrations = this.getMigrations(fromVersion, toVersion);
    return migrations.reduce((state, migration) => migration(state), data);
  }
}
```

#### 4.4.3 自动保存机制

```typescript
class AutoSaveManager {
  private saveTimer: NodeJS.Timeout | null = null;
  private pendingSave = false;
  private lastSaveTime = 0;

  // 启动自动保存
  startAutoSave(interval: number = 30000) {
    this.saveTimer = setInterval(() => {
      this.performAutoSave();
    }, interval);
  }

  // 执行自动保存
  private async performAutoSave() {
    if (this.pendingSave) return;

    this.pendingSave = true;
    try {
      const gameState = store.getState().game;
      const hasChanges = this.hasSignificantChanges(gameState);

      if (hasChanges) {
        await this.saveGameState(gameState);
        this.lastSaveTime = Date.now();
      }
    } catch (error) {
      console.error("自动保存失败:", error);
    } finally {
      this.pendingSave = false;
    }
  }

  // 强制保存
  async forceSave(): Promise<void> {
    if (this.saveTimer) {
      clearInterval(this.saveTimer);
    }
    await this.performAutoSave();
    this.startAutoSave();
  }

  // 检查是否有重要变化
  private hasSignificantChanges(gameState: GameState): boolean {
    // 检查资源变化
    // 检查设备状态变化
    // 检查研发进度变化
    // 返回是否需要保存
    return true;
  }
}
```

## 5. 用户体验设计

### 5.1 新手引导系统

#### 5.1.1 引导流程设计

```
新手引导步骤：
├── 第一步：界面介绍 (30秒)
│   ├── 展示主界面各区域功能
│   ├── 说明分类标签的作用
│   └── 介绍物品网格布局
│
├── 第二步：基础操作 (60秒)
│   ├── 点击物品查看详情
│   ├── 尝试手动开采铁矿石
│   └── 观察库存数量变化
│
├── 第三步：自动化入门 (90秒)
│   ├── 建造第一台热力采掘机
│   ├── 观察自动开采过程
│   └── 理解燃料自动补充机制
│
├── 第四步：生产链建立 (120秒)
│   ├── 建造熔炉冶炼铁板
│   ├── 制作第一个铁齿轮
│   └── 完成第一个科技包制作
│
└── 第五步：科技研发 (60秒)
    ├── 使用科技包解锁新技术
    ├── 建造装配机实现自动化
    └── 设置第一条完整生产线
```

#### 5.1.2 引导机制设计

```typescript
interface TutorialStep {
  id: string;
  title: string;
  description: string;
  targetElement?: string;
  highlightArea?: "circle" | "rectangle";
  action?: "tap" | "drag" | "wait";
  condition?: () => boolean;
  onComplete?: () => void;
  skippable: boolean;
}

class TutorialManager {
  private currentStep = 0;
  private steps: TutorialStep[] = [];
  private overlay: React.Component | null = null;

  // 开始引导
  startTutorial(tutorialId: string) {
    this.steps = this.loadTutorialSteps(tutorialId);
    this.showNextStep();
  }

  // 显示下一步
  showNextStep() {
    if (this.currentStep >= this.steps.length) {
      this.completeTutorial();
      return;
    }

    const step = this.steps[this.currentStep];
    this.showStepOverlay(step);
  }

  // 检查步骤完成条件
  checkStepCompletion() {
    const step = this.steps[this.currentStep];
    if (step.condition && step.condition()) {
      this.currentStep++;
      this.showNextStep();
    }
  }
}
```

### 5.2 游戏平衡性设计

#### 5.2.1 进度曲线设计

```
游戏进度平衡：
├── 早期阶段 (0-30分钟)
│   ├── 手动操作为主
│   ├── 资源获取容易
│   ├── 制作时间短
│   └── 快速正反馈
│
├── 发展阶段 (30分钟-2小时)
│   ├── 自动化入门
│   ├── 设备建造成本合理
│   ├── 生产链逐步复杂
│   └── 科技解锁有序
│
├── 扩张阶段 (2-8小时)
│   ├── 大规模自动化
│   ├── 资源需求增加
│   ├── 效率优化挑战
│   └── 高级科技解锁
│
└── 优化阶段 (8小时以上)
    ├── 完全自动化
    ├── 效率极限挑战
    ├── 复杂生产链
    └── 无限扩展可能
```

#### 5.2.2 经济平衡设计

```
资源平衡公式：
├── 基础资源比例：
│   ├── 铁矿石：基准 (1.0)
│   ├── 铜矿石：0.8倍需求
│   ├── 煤炭：0.6倍需求 (但多用途)
│   └── 石头：0.4倍需求
│
├── 设备成本曲线：
│   ├── 基础设备：线性增长
│   ├── 高级设备：指数增长
│   ├── 升级成本：等级^1.5
│   └── 维护成本：固定比例
│
├── 生产效率曲线：
│   ├── 手动效率：1.0倍
│   ├── 基础自动化：5-10倍
│   ├── 高级自动化：50-100倍
│   └── 极限效率：1000倍+
│
└── 科技解锁成本：
    ├── 红色科技：10-50包
    ├── 绿色科技：20-100包
    ├── 蓝色科技：50-200包
    └── 高级科技：100-500包
```

### 5.3 错误处理和用户反馈

#### 5.3.1 错误处理策略

```
错误处理机制：
├── 数据错误：
│   ├── 自动数据验证
│   ├── 损坏数据修复
│   ├── 备份数据恢复
│   └── 默认值填充
│
├── 操作错误：
│   ├── 输入验证
│   ├── 操作确认
│   ├── 撤销功能
│   └── 错误提示
│
├── 系统错误：
│   ├── 异常捕获
│   ├── 错误日志
│   ├── 崩溃恢复
│   └── 降级处理
│
└── 网络错误：
    ├── 离线模式
    ├── 重试机制
    ├── 缓存策略
    └── 同步恢复
```

#### 5.3.2 用户反馈系统

```
反馈机制设计：
├── 即时反馈：
│   ├── 按钮点击效果
│   ├── 数值变化动画
│   ├── 状态指示灯
│   └── 进度条更新
│
├── 操作确认：
│   ├── 成功操作提示
│   ├── 失败原因说明
│   ├── 警告信息展示
│   └── 建议操作指导
│
├── 进度反馈：
│   ├── 制作进度显示
│   ├── 研发进度追踪
│   ├── 建造进度提示
│   └── 升级进度展示
│
└── 系统通知：
    ├── 重要事件通知
    ├── 错误警告提示
    ├── 成就解锁通知
    └── 更新提醒信息
```

## 6. 测试验收标准

### 6.1 功能测试要求

#### 6.1.1 核心功能测试

```
功能测试清单：
├── 物品管理：
│   ✓ 物品分类正确显示
│   ✓ 物品网格布局正确
│   ✓ 物品详情数据准确
│   ✓ 库存数量实时更新
│
├── 设备管理：
│   ✓ 设备建造功能正常
│   ✓ 设备数量调整正确
│   ✓ 设备状态显示准确
│   ✓ 自动化生产正常
│
├── 制作系统：
│   ✓ 手动制作功能正常
│   ✓ 制作队列管理正确
│   ✓ 进度显示准确
│   ✓ 材料消耗正确
│
├── 自动化系统：
│   ✓ 燃料自动补充正常
│   ✓ 原料自动消耗正确
│   ✓ 设备自动启停正常
│   ✓ 生产计算准确
│
└── 数据持久化：
    ✓ 自动保存功能正常
    ✓ 手动保存功能正常
    ✓ 数据加载正确
    ✓ 多存档管理正常
```

#### 6.1.2 边界条件测试

```
边界测试场景：
├── 资源极限：
│   ✓ 库存为0时的处理
│   ✓ 库存达到上限的处理
│   ✓ 负数资源的防护
│   ✓ 超大数值的处理
│
├── 设备极限：
│   ✓ 设备数量为0的处理
│   ✓ 设备数量达到上限
│   ✓ 所有设备停机的情况
│   ✓ 设备效率为0的处理
│
├── 时间极限：
│   ✓ 游戏时间超长的处理
│   ✓ 制作时间为0的处理
│   ✓ 系统时间异常的处理
│   ✓ 离线时间过长的处理
│
└── 数据极限：
    ✓ 存档大小超限的处理
    ✓ 存档数量超限的处理
    ✓ 数据损坏的恢复
    ✓ 版本不兼容的处理
```

### 6.2 性能测试标准

#### 6.2.1 响应时间要求

```
性能基准：
├── 界面响应：
│   ✓ 点击响应 < 100ms
│   ✓ 页面切换 < 300ms
│   ✓ 数据更新 < 200ms
│   ✓ 动画流畅 60fps
│
├── 数据处理：
│   ✓ 游戏循环 < 10ms
│   ✓ 保存操作 < 1000ms
│   ✓ 加载操作 < 3000ms
│   ✓ 计算更新 < 50ms
│
├── 内存使用：
│   ✓ 基础内存 < 100MB
│   ✓ 峰值内存 < 200MB
│   ✓ 内存增长 < 1MB/小时
│   ✓ 内存释放及时
│
└── 电池消耗：
    ✓ 待机模式 < 1%/小时
    ✓ 活跃模式 < 10%/小时
    ✓ 后台模式 < 2%/小时
    ✓ 充电时无过热
```

#### 6.2.2 压力测试要求

```
压力测试场景：
├── 数据量压力：
│   ✓ 1000+ 设备实例
│   ✓ 10000+ 物品库存
│   ✓ 100+ 制作队列任务
│   ✓ 长时间连续运行
│
├── 操作频率压力：
│   ✓ 快速点击测试
│   ✓ 大量并发操作
│   ✓ 频繁保存加载
│   ✓ 快速切换界面
│
├── 资源压力：
│   ✓ 低内存设备测试
│   ✓ 存储空间不足测试
│   ✓ 电量不足测试
│   ✓ 网络不稳定测试
│
└── 时间压力：
    ✓ 7×24小时稳定运行
    ✓ 频繁前后台切换
    ✓ 长期数据累积
    ✓ 系统资源竞争
```

### 6.3 兼容性测试要求

#### 6.3.1 设备兼容性

```
设备测试矩阵：
├── iOS设备：
│   ✓ iPhone SE (4.7")
│   ✓ iPhone 12 (6.1")
│   ✓ iPhone 12 Pro Max (6.7")
│   ✓ iPad (10.2")
│
├── Android设备：
│   ✓ 小屏设备 (5.0"-5.5")
│   ✓ 标准设备 (5.5"-6.0")
│   ✓ 大屏设备 (6.0"-6.7")
│   ✓ 平板设备 (7"+)
│
├── 系统版本：
│   ✓ iOS 12+ (最低支持)
│   ✓ iOS 15+ (推荐)
│   ✓ Android 7+ (最低支持)
│   ✓ Android 10+ (推荐)
│
└── 硬件配置：
    ✓ 2GB RAM (最低)
    ✓ 4GB RAM (推荐)
    ✓ 32GB 存储 (最低)
    ✓ 64GB 存储 (推荐)
```

## 7. 发布和维护计划

### 7.1 版本发布计划

#### 7.1.1 MVP 版本 (v1.0)

```
v1.0 功能清单：
├── 核心功能 (必须):
│   ✓ 7大分类物品管理
│   ✓ 简化物品详情页面
│   ✓ 基础设备管理
│   ✓ 手动和自动生产
│   ✓ 本地存储系统
│
├── 基础功能 (必须):
│   ✓ 制作队列系统
│   ✓ 科技研发系统
│   ✓ 新手引导系统
│   ✓ 基础设置功能
│
├── 优化功能 (可选):
│   ✓ 性能优化
│   ✓ 动画效果
│   ✓ 音效支持
│   ✓ 多语言支持
│
└── 发布目标:
    ✓ iOS App Store
    ✓ Google Play Store
    ✓ 基础用户获取
    ✓ 用户反馈收集
```

#### 7.1.2 迭代版本计划

```
版本迭代路线图：
├── v1.1 (发布后1个月):
│   ├── Bug修复和性能优化
│   ├── 用户反馈功能改进
│   ├── 新增成就系统
│   └── 社交分享功能
│
├── v1.2 (发布后3个月):
│   ├── 新增高级设备类型
│   ├── 扩展科技树内容
│   ├── 新增统计分析功能
│   └── 改进UI界面
│
├── v1.3 (发布后6个月):
│   ├── 新增军事装备系统
│   ├── 扩展化工生产链
│   ├── 新增挑战模式
│   └── 云存档支持
│
└── v2.0 (发布后1年):
    ├── 多人合作模式
    ├── 工厂设计分享
    ├── 高级自动化系统
    └── 3D可视化界面
```

### 7.2 运营维护计划

#### 7.2.1 日常维护任务

```
维护任务清单：
├── 每日任务:
│   ✓ 监控服务器状态
│   ✓ 检查崩溃报告
│   ✓ 回复用户反馈
│   ✓ 监控关键指标
│
├── 每周任务:
│   ✓ 分析用户数据
│   ✓ 更新内容计划
│   ✓ Bug修复优先级
│   ✓ 竞品分析调研
│
├── 每月任务:
│   ✓ 版本发布计划
│   ✓ 功能需求评估
│   ✓ 技术债务清理
│   ✓ 团队绩效评估
│
└── 每季度任务:
    ✓ 产品路线图调整
    ✓ 技术架构升级
    ✓ 市场策略调整
    ✓ 团队能力建设
```

#### 7.2.2 用户支持体系

```
用户支持计划：
├── 技术支持:
│   ├── 常见问题解答
│   ├── 在线客服系统
│   ├── 用户手册文档
│   └── 视频教程制作
│
├── 社区运营:
│   ├── 官方社区建设
│   ├── 用户活动策划
│   ├── 内容创作激励
│   └── 意见反馈收集
│
├── 问题处理:
│   ├── Bug报告处理流程
│   ├── 功能需求收集
│   ├── 用户投诉处理
│   └── 数据恢复服务
│
└── 持续改进:
    ├── 用户体验优化
    ├── 功能迭代升级
    ├── 性能持续优化
    └── 新技术应用探索
```

---

## 附录

### A. 术语表

- **物品 (Item)**: 游戏中的所有可管理对象
- **设备 (Equipment)**: 用于生产物品的建筑
- **设施 (Facility)**: 设备的同义词，在界面中使用
- **配方 (Recipe)**: 物品的制作方法和材料需求
- **科技包 (Science Pack)**: 用于研发科技的特殊物品
- **净增长 (Net Growth)**: 物品的产量减去消耗量

### B. 数据字典

详细的数据结构定义和字段说明

### C. API 接口文档

内部数据接口和方法定义

### D. 设计资源

UI 设计稿、图标资源、动画规范等

---

**文档信息**

- 版本：v3.3
- 更新日期：2025 年 1 月 27 日
- 文档状态：架构优化 - 分离生产与设施管理
- 主要更新内容：

  **基础功能改进：**
  - 物品分类调整为基于 Factorio 的 6 大分类
  - 配方数据结构适配 Factorio 格式
  - 科技系统基于 Factorio 科技包
  - 生产设备基于 Factorio 实际设备类型
  
  **UI/UX 优化：**
  - **新增底部Tab导航**：生产、设施、科技、统计、设置、任务六大功能模块
  - **优化物品卡片设计**：增大尺寸至90×110px，添加长按快速信息展示
  - **新增智能搜索系统**：支持多维度搜索，包括物品名、配方、用途等
  - **整合生产链可视化**：作为基地Tab的子分类，支持层级图和流程图视图
  - **改进数值显示**：用户友好的数值格式，支持自动单位转换
  - **优化设备管理界面**：折叠/展开视图，批量操作，滑动手势支持
  
  **核心系统增强：**
  - **新增库存更新系统**：累积小数方案处理非整数产量
  - **新增统计分析系统**：实时生产效率统计，瓶颈检测，优化建议
  - **新增离线收益系统**：分阶段效率递减，详细离线报告
  - **改进新手引导系统**：渐进式内容解锁，交互式教程
  - **新增音效振动系统**：完整的音效设计和智能振动反馈
  
  **社交功能：**
  - **新增轻社交功能**：成就分享、好友码系统、本地排行榜
  - **新增每周挑战**：定期更新的挑战任务，增加游戏粘性
  - **新增工厂展示**：截图美化、数据卡片生成
  
  **存储和性能：**
  - **完善存储设备机制**：添加设备时消耗库存，智能按钮状态
  - **新增性能优化实现**：批量更新和对象池优化
  - **改进手动生产队列**：材料预扣、链式制作、取消操作优化

- 下一版本计划：
  - 实施用户测试反馈
  - 优化性能瓶颈
  - 添加更多可视化图表
  - 扩展社交功能

### 2.16 改进的设备管理系统（新增）

#### 2.14.1 设备详情展示优化

```typescript
interface EnhancedEquipmentManagement {
  // 设备列表视图改进
  listView: {
    // 折叠/展开状态
    collapsible: true,
    defaultState: 'collapsed',
    
    // 折叠时显示摘要
    collapsedSummary: {
      totalCount: number,
      runningCount: number,
      averageEfficiency: number,
      totalProduction: number
    },
    
    // 展开时显示详细列表
    expandedDetails: {
      // 分组显示选项
      groupBy: ['type', 'status', 'efficiency'],
      
      // 每个设备的详细信息
      equipmentCard: {
        id: string,
        type: string,
        status: 'running' | 'stopped' | 'maintenance' | 'no-fuel',
        efficiency: number,
        fuel: number,          // 百分比
        production: number,    // 实时产量
        runtime: number,       // 运行时间
        lastMaintenance: number
      },
      
      // 批量操作
      bulkActions: {
        enabled: true,
        actions: ['start-all', 'stop-all', 'maintain-all', 'upgrade-selected']
      }
    }
  },
  
  // 设备监控面板
  monitoringPanel: {
    // 实时性能指标
    metrics: {
      uptime: { value: number, unit: 'percent' },
      efficiency: { value: number, trend: 'up' | 'down' | 'stable' },
      fuelConsumption: { value: number, unit: 'per-hour' },
      maintenanceNeeded: { count: number, urgent: number }
    },
    
    // 性能图表
    charts: {
      efficiencyTrend: {
        type: 'line',
        timeRange: ['1h', '6h', '24h'],
        showAverage: true
      },
      statusDistribution: {
        type: 'donut',
        categories: ['运行中', '停止', '维护中', '缺燃料']
      }
    },
    
    // 告警系统
    alerts: {
      lowFuel: { threshold: 20, severity: 'warning' },
      lowEfficiency: { threshold: 50, severity: 'info' },
      maintenanceOverdue: { threshold: 1000, severity: 'critical' }
    }
  }
}
```

#### 2.14.2 设备快速操作

```
设备管理界面布局（改进版）：
┌─────────────────────────────────┐
│ 🏭 电力采掘机 (5台)      [▼展开] │
│ ●●●○○ 3/5运行 | 效率: 72%       │
│ 总产量: +12.5/秒                │
├─────────────────────────────────┤
│ 展开后显示:                     │
│ ┌─────────────────────────────┐ │
│ │ #1 ● 运行中 100% ⛽90%      │ │
│ │    产量: +2.5/秒  运行: 2h  │ │
│ │ [暂停] [维护] [升级]        │ │
│ ├─────────────────────────────┤ │
│ │ #2 ● 运行中 80% ⛽85%       │ │
│ │    产量: +2.0/秒  运行: 3h  │ │
│ │ [暂停] [维护] [升级]        │ │
│ └─────────────────────────────┘ │
│ [全部启动] [全部停止] [批量维护] │
└─────────────────────────────────┘
```

**滑动手势操作：**
- 左滑：快速停止设备
- 右滑：快速维护设备
- 长按：显示设备详细信息

### 2.17 音效和振动反馈系统（新增）

#### 2.15.1 音效设计系统

```typescript
interface AudioSystem {
  // 音效分类
  categories: {
    // UI交互音效
    ui: {
      tap: 'click_soft.wav',        // 普通点击
      confirm: 'confirm.wav',        // 确认操作
      cancel: 'cancel.wav',          // 取消操作
      switch: 'switch_tab.wav',      // 切换标签
      drag: 'drag_item.wav'          // 拖拽
    },
    
    // 生产音效
    production: {
      start: 'machine_start.wav',    // 设备启动
      stop: 'machine_stop.wav',      // 设备停止
      produce: 'item_produced.wav',  // 物品产出
      complete: 'craft_complete.wav' // 制作完成
    },
    
    // 提示音效
    notification: {
      success: 'success_bell.wav',   // 成功提示
      warning: 'warning_beep.wav',   // 警告提示
      error: 'error_buzz.wav',       // 错误提示
      achievement: 'achievement.wav'  // 成就解锁
    },
    
    // 环境音效
    ambient: {
      factory: 'factory_ambience.wav', // 工厂环境音
      menu: 'menu_ambience.wav'        // 菜单背景音
    }
  },
  
  // 音效设置
  settings: {
    // 分类音量控制
    volumeControl: {
      master: 1.0,
      ui: 0.8,
      production: 0.6,
      notification: 1.0,
      ambient: 0.4
    },
    
    // 智能音效
    smartAudio: {
      // 防止音效轰炸
      antiSpam: {
        enabled: true,
        cooldown: 100, // 相同音效最小间隔ms
        maxSimultaneous: 3
      },
      
      // 动态混音
      dynamicMixing: true
    }
  }
}
```

#### 2.15.2 振动反馈系统

```typescript
interface HapticSystem {
  // 振动模式
  patterns: {
    // 轻触反馈
    light: {
      duration: 10,
      intensity: 0.3,
      usage: ['tap', 'switch']
    },
    
    // 中等反馈
    medium: {
      duration: 20,
      intensity: 0.6,
      usage: ['confirm', 'produce']
    },
    
    // 强反馈
    heavy: {
      duration: 30,
      intensity: 1.0,
      usage: ['error', 'achievement']
    },
    
    // 自定义模式
    custom: {
      success: [10, 20, 10], // 振动-停止-振动
      warning: [20, 10, 20, 10, 20],
      notification: [15, 15]
    }
  },
  
  // 智能振动
  smartHaptics: {
    // 根据操作重要性调整
    contextual: true,
    
    // 电量低时自动关闭
    batteryAware: true,
    
    // 静音模式下增强振动
    silentModeEnhance: true
  }
}
```

### 2.18 社交功能系统（新增）

#### 2.16.1 轻社交设计

```typescript
interface SocialFeatures {
  // 成就分享系统
  achievements: {
    shareable: true,
    
    // 分享模板
    templates: {
      firstAutomation: {
        title: '我在异星工厂建造了第一条自动化生产线！',
        image: 'achievement_automation.png',
        stats: ['游戏时长', '生产效率']
      },
      
      productionMilestone: {
        title: '我的工厂每分钟生产{0}个{1}！',
        image: 'dynamic', // 动态生成
        stats: ['总产量', '设备数量']
      }
    },
    
    // 分享渠道
    channels: ['微信', '朋友圈', 'QQ', '微博', '截图保存']
  },
  
  // 本地排行榜
  localLeaderboards: {
    // 好友码系统
    friendCode: {
      format: 'XXXX-XXXX', // 8位好友码
      features: {
        generate: true,
        share: true,
        compare: true // 通过好友码比较数据
      }
    },
    
    // 排行榜类型
    categories: [
      '最高效率',
      '最快通关',
      '最少设备',
      '最大产量'
    ]
  },
  
  // 工厂展示
  factoryShowcase: {
    // 截图美化
    screenshot: {
      filters: ['原始', '蓝图', '数据', '艺术'],
      watermark: true,
      statsOverlay: true
    },
    
    // 数据卡片生成
    dataCard: {
      layout: 'infographic',
      metrics: [
        '总产量',
        '设备数量', 
        '运行时间',
        '最高效率'
      ],
      customizable: true
    }
  }
}
```

#### 2.16.2 每周挑战系统

```
每周挑战界面：
┌─────────────────────────────────┐
│ 🏆 本周挑战：极限效率           │
│ 剩余时间：3天14小时             │
├─────────────────────────────────┤
│ 目标：使用最少设备达到100/分钟   │
│ 限制：最多10台生产设备          │
├─────────────────────────────────┤
│ 当前进度：                      │
│ 产量：85/分钟 (85%)             │
│ 设备：8/10                      │
├─────────────────────────────────┤
│ 排行榜：                        │
│ 1. 玩家A - 7台设备              │
│ 2. 玩家B - 8台设备              │
│ 3. 你 - 8台设备                 │
├─────────────────────────────────┤
│ [分享进度] [查看攻略]           │
└─────────────────────────────────┘
```

### 2.19 数值显示优化系统（新增）

#### 2.17.1 用户友好的数值格式

```typescript
interface UserFriendlyNumbers {
  // 生产速率显示选项
  productionRateFormat: {
    modes: {
      perSecond: '1.33/秒',      // 默认
      perMinute: '80/分钟',      // 友好
      perHour: '4.8K/小时',      // 长期
      auto: 'auto'               // 自动选择
    },
    
    // 自动格式化逻辑
    autoFormat: (rate: number) => {
      if (rate < 0.1) return { value: rate * 3600, unit: '/小时' };
      if (rate < 1) return { value: rate * 60, unit: '/分钟' };
      if (rate > 10) return { value: Math.round(rate), unit: '/秒' };
      return { value: rate.toFixed(1), unit: '/秒' };
    }
  },
  
  // 时间显示优化
  timeFormat: {
    modes: {
      exact: '90秒',           // 精确
      friendly: '1分30秒',     // 友好
      relative: '约2分钟',     // 相对
      countdown: '还需1:30'    // 倒计时
    }
  },
  
  // 显示设置界面
  displaySettings: {
    rateUnit: {
      label: '生产速率单位',
      options: ['每秒', '每分钟', '每小时', '自动'],
      default: '自动'
    },
    
    numberFormat: {
      label: '数字格式',
      options: ['精确', '简化', '科学计数'],
      default: '简化'
    },
    
    timeDisplay: {
      label: '时间显示',
      options: ['精确', '友好', '相对'],
      default: '友好'
    }
  }
}
```

#### 3.1.4 Tab功能详细设定（新增）

##### 生产Tab - 物品生产与库存管理

**功能模块：**

1. **物品库存管理**
   ```typescript
   interface BaseTabFeatures {
     inventory: {
       // 物品显示
       itemGrid: {
         columns: 4,
         itemsPerPage: 20,
         lazyLoading: true,
         pullToRefresh: true
       },
       
       // 库存操作
       operations: {
         quickCraft: true,        // 快速制作
         batchSelect: true,       // 批量选择
         favoriteItems: true,     // 收藏物品
         searchHistory: true      // 搜索历史
       },
       
       // 库存预警
       alerts: {
         lowStock: { threshold: 10, notification: true },
         fullStorage: { threshold: 95, autoStop: true },
         criticalMaterials: ['coal', 'iron-ore', 'copper-ore']
       }
     }
   }
   ```

2. **生产监控**
   - 实时生产速率显示
   - 设备运行状态总览
   - 资源流动可视化
   - 瓶颈提示（简化版）

3. **快捷操作**
   - 一键收取所有产出
   - 快速补充燃料
   - 批量启停设备
   - 快速跳转到问题设备

4. **信息展示优先级**
   - 第一优先级：库存告急物品
   - 第二优先级：生产异常（停产、缺料）
   - 第三优先级：可升级提示
   - 第四优先级：正常生产信息

##### 科技Tab - 研究发展系统

**功能模块：**

1. **科技树展示**
   ```typescript
   interface TechnologyTabFeatures {
     techTree: {
       // 显示模式
       viewModes: {
         tree: '树状图',      // 传统科技树
         list: '列表视图',    // 简化列表
         progress: '进度视图' // 按完成度排序
       },
       
       // 科技分类
       categories: {
         automation: '自动化',
         logistics: '物流',
         military: '军事',
         production: '生产',
         utility: '实用'
       },
       
       // 交互功能
       interactions: {
         tapToView: true,     // 点击查看详情
         longPressToQueue: true, // 长按加入队列
         swipeToNavigate: true   // 滑动导航
       }
     }
   }
   ```

2. **研究管理**
   - 当前研究进度条（始终置顶）
   - 研究队列管理（最多5个）
   - 科技包需求显示
   - 预计完成时间

3. **解锁预览**
   - 显示科技解锁内容
   - 新配方高亮提示
   - 新建筑解锁通知
   - 效率提升预览

4. **研究加速**
   - 增加实验室数量
   - 科技包库存检查
   - 自动补充科技包（可选）
   - 离线研究进度

##### 统计Tab - 数据分析中心

**功能模块：**

1. **核心指标面板**
   ```typescript
   interface StatisticsTabFeatures {
     dashboard: {
       // 关键指标卡片
       keyMetrics: [
         { id: 'efficiency', name: '总效率', format: 'percentage' },
         { id: 'production', name: '总产量', format: 'rate' },
         { id: 'consumption', name: '消耗率', format: 'rate' },
         { id: 'uptime', name: '运行时间', format: 'duration' }
       ],
       
       // 时间范围选择
       timeRanges: {
         realtime: '实时',
         hour: '1小时',
         day: '24小时',
         week: '7天',
         all: '全部'
       }
     }
   }
   ```

2. **详细分析**
   - **生产分析**
     - 各物品产量排行
     - 生产效率对比
     - 产能利用率
   
   - **消耗分析**
     - 原材料消耗TOP10
     - 燃料使用统计
     - 浪费率分析
   
   - **瓶颈分析**
     - 自动识别生产瓶颈
     - 供需平衡图表
     - 改进建议生成

3. **数据可视化**
   - 折线图：趋势分析
   - 饼图：占比分析
   - 柱状图：排行对比
   - 热力图：效率分布

4. **报表导出**
   - 生成每日报表
   - 分享统计截图
   - 历史数据对比

##### 设置Tab - 个性化配置

**功能模块：**

1. **游戏设置**
   ```typescript
   interface SettingsTabFeatures {
     gameSettings: {
       // 游戏难度
       difficulty: {
         resourceMultiplier: number,  // 资源倍率
         costMultiplier: number,      // 成本倍率
         offlineEfficiency: number    // 离线效率
       },
       
       // 自动化设置
       automation: {
         autoSave: { interval: 30, enabled: true },
         autoCollect: { enabled: false },
         autoRestart: { enabled: true },
         smartFuel: { enabled: true }
       },
       
       // 通知设置
       notifications: {
         production: boolean,
         research: boolean,
         achievement: boolean,
         maintenance: boolean
       }
     }
   }
   ```

2. **显示设置**
   - 数值显示格式
   - 语言切换
   - 主题选择（可选）
   - 动画开关
   - 性能模式

3. **音效设置**
   - 主音量控制
   - 分类音量调节
   - 振动反馈强度
   - 静音模式快捷开关

4. **账号与数据**
   - 存档管理
   - 云同步（未来）
   - 数据备份/恢复
   - 清除缓存
   - 重置教程

##### 任务Tab - 目标与成就

**功能模块：**

1. **任务系统**
   ```typescript
   interface MissionTabFeatures {
     missions: {
       // 任务类型
       daily: {
         resetTime: '00:00',
         maxActive: 3,
         rewards: ['resources', 'currency', 'boosts']
       },
       
       weekly: {
         resetDay: 'Monday',
         difficulty: 'scaling',
         leaderboard: true
       },
       
       // 任务追踪
       tracking: {
         autoTrack: true,
         progressBar: true,
         notification: true,
         quickComplete: false  // 不支持快速完成
       }
     }
   }
   ```

2. **每日任务**
   - 3个随机任务
   - 难度递进
   - 完成奖励资源
   - 连续签到奖励

3. **每周挑战**
   - 特定目标挑战
   - 排行榜系统
   - 独特奖励
   - 分享挑战进度

4. **成就系统**
   - 分类成就展示
   - 进度追踪
   - 成就点数
   - 成就墙展示
   - 隐藏成就

5. **奖励中心**
   - 待领取奖励
   - 奖励历史
   - 特殊活动奖励

#### 3.1.5 Tab间交互设计

**跨Tab功能联动：**

1. **生产 ↔ 设施**
   - 生产Tab制作设施物品 → 设施Tab部署使用
   - 设施Tab显示缺少的设施 → 跳转生产Tab制作
   - 生产效率低 → 提示增加生产设施

2. **设施 → 科技**
   - 点击未解锁设施跳转到对应科技
   - 实验室管理直接影响科技研究速度

3. **生产 → 统计**
   - 长按物品查看该物品统计
   - 生产异常时快速跳转分析

4. **统计 → 生产/设施**
   - 点击瓶颈物品跳转到生产Tab
   - 电力不足提示跳转到设施Tab
   - 一键应用优化建议

5. **任务 → 各Tab**
   - 任务引导跳转
   - 完成提示定位

6. **设施 → 生产**
   - 燃料/弹药不足时跳转到生产Tab
   - 设施维护需要材料时提示

**全局浮动元素：**
- 制作队列气泡（所有Tab可见）
- 重要通知提示（优先级显示）
- 快捷操作按钮（可自定义）

#### 3.1.6 Tab切换与状态管理

**切换动画：**
```typescript
interface TabTransition {
  animation: {
    type: 'slide' | 'fade',
    duration: 200,
    easing: 'ease-out'
  },
  
  // 切换时的状态保持
  statePreservation: {
    scrollPosition: true,     // 保持滚动位置
    filterSelection: true,    // 保持筛选状态
    expandedItems: true,      // 保持展开状态
    searchQuery: false        // 不保持搜索内容
  }
}
```

**Tab徽章系统：**
```typescript
interface TabBadges {
  // 数字徽章
  numeric: {
    missions: number,         // 待完成任务数
    settings: number,         // 需要处理的设置项
  },
  
  // 状态徽章
  status: {
    technology: 'researching' | 'completed' | 'idle',
    statistics: 'alert' | 'normal',
  },
  
  // 特殊徽章
  special: {
    base: 'production-stopped' | 'storage-full',
    missions: 'new' | 'reward-available'
  }
}
```

**快速访问设计：**
1. **长按Tab图标**：显示该Tab的快捷菜单
2. **双击Tab图标**：快速定位到默认位置
3. **下拉刷新**：在任意Tab都可以刷新数据

**性能优化：**
- 非活跃Tab降低更新频率
- 预加载相邻Tab内容
- 懒加载图表和复杂视图
- 缓存常用数据避免重复计算

#### 3.1.7 新手引导Tab集成

**分Tab引导流程：**

1. **第一次进入游戏**
   - 默认在基地Tab
   - 引导基础物品操作
   - 限制其他Tab访问

2. **解锁顺序**
   ```
   基地Tab（默认开启）
   ↓ 生产10个物品后
   科技Tab（解锁）
   ↓ 完成第一个科技后
   统计Tab（解锁）
   ↓ 游戏时间达到30分钟
   任务Tab（解锁）
   ↓ 
   设置Tab（始终可用）
   ```

3. **Tab引导标记**
   - 新解锁的Tab显示"NEW"标记
   - 首次进入显示功能介绍
   - 关键功能高亮提示

#### 3.1.8 特殊场景处理

**离线返回处理：**
```typescript
interface OfflineReturnHandler {
  // 返回游戏时的Tab行为
  onReturn: {
    showOfflineReport: true,      // 显示离线报告
    defaultTab: 'production',     // 默认返回生产Tab
    notifications: {
      research: '研究完成通知',
      production: '生产异常通知',
      mission: '任务完成通知'
    }
  },
  
  // Tab数据刷新优先级
  refreshPriority: [
    'base',       // 最先刷新
    'technology', // 其次
    'statistics', // 然后
    'missions',   // 最后
    'settings'    // 无需刷新
  ]
}
```

**异常状态处理：**

1. **生产停止时**
   - 基地Tab显示红色提示
   - Tab图标显示警告徽章
   - 自动定位到问题物品

2. **存储满时**
   - 相关物品显示满仓标记
   - 统计Tab显示存储分析
   - 建议扩容或消耗

3. **科技完成时**
   - 科技Tab显示完成动画
   - 基地Tab刷新解锁物品
   - 弹出解锁提示

**数据同步机制：**
```typescript
interface TabDataSync {
  // 实时同步项目
  realtime: {
    productionRates: true,
    inventoryLevels: true,
    equipmentStatus: true
  },
  
  // 定时同步项目（5秒）
  periodic: {
    statistics: true,
    achievements: true,
    leaderboards: true
  },
  
  // 手动触发同步
  manual: {
    pullToRefresh: true,
    backgroundRefresh: true
  }
}
```

**跨Tab数据共享：**
```typescript
// 全局数据存储
interface GlobalDataStore {
  // 共享数据
  shared: {
    inventory: Map<string, number>,
    production: Map<string, ProductionData>,
    research: ResearchProgress,
    missions: MissionProgress[]
  },
  
  // Tab私有数据
  private: {
    base: { scrollPosition: number, filter: string },
    technology: { selectedTech: string },
    statistics: { timeRange: string },
    missions: { activeTab: string },
    settings: { openSection: string }
  }
}
```

#### 3.1.9 Tab功能优先级

**核心功能（MVP）：**
1. 基地Tab：物品网格、生产监控、快速制作
2. 科技Tab：科技树、研究进度
3. 统计Tab：基础数据展示
4. 设置Tab：基本设置项
5. 任务Tab：每日任务

**进阶功能（v1.1）：**
1. 基地Tab：生产链视图、批量操作
2. 科技Tab：研究队列、自动研究
3. 统计Tab：数据分析、优化建议
4. 设置Tab：高级选项、数据管理
5. 任务Tab：每周挑战、成就系统

**高级功能（v1.2+）：**
1. 跨Tab联动优化
2. 智能提醒系统
3. 自定义Tab顺序
4. 快捷操作配置
5. 深度数据分析

##### 设施Tab - 设备部署与管理（新增）

**功能模块：**

1. **设施概览仪表盘**
   ```typescript
   interface FacilitiesTabFeatures {
     dashboard: {
       // 顶部状态栏
       statusBar: {
         power: { current: number, max: number, unit: 'MW' },
         research: { labs: number, speed: number },
         defense: { status: 'normal' | 'alert' | 'critical' }
       },
       
       // 设施分类
       categories: {
         power: '电力设施',
         production: '生产设施',
         research: '研究设施',
         defense: '防御设施',
         logistics: '物流设施'
       }
     }
   }
   ```

2. **电力系统管理**
   ```typescript
   interface PowerManagement {
     // 发电设施
     generators: {
       'steam-engine': { power: 900, fuel: 'coal' },
       'solar-panel': { power: 60, condition: 'daylight' },
       'accumulator': { capacity: 5000, io: 300 },
       'nuclear-reactor': { power: 40000, fuel: 'uranium' }
     },
     
     // 电力统计
     statistics: {
       totalGeneration: number,
       totalConsumption: number,
       satisfaction: number, // 百分比
       timeToEmpty: number  // 蓄电池耗尽时间
     },
     
     // 电网管理
     grid: {
       autoBalance: true,
       priorityList: ['defense', 'research', 'production'],
       emergencyShutdown: ['non-critical']
     }
   }
   ```

3. **生产设施管理**
   - **采矿设施**：采矿机部署、矿区管理
   - **加工设施**：熔炉、装配机配置
   - **化工设施**：化工厂、炼油厂管理
   - **效率优化**：模块插槽、升级管理

4. **研究设施管理**
   - 实验室数量控制
   - 研究速度显示
   - 科技包供应监控
   - 快速跳转到科技Tab

5. **防御系统**
   ```typescript
   interface DefenseSystem {
     // 防御设施类型
     structures: {
       'gun-turret': { damage: 5, range: 18, ammo: 'firearm-magazine' },
       'laser-turret': { damage: 20, range: 24, power: 800 },
       'flamethrower-turret': { damage: 100, range: 30, ammo: 'flamethrower-ammo' },
       'wall': { health: 350, type: 'passive' },
       'gate': { health: 350, type: 'interactive' }
     },
     
     // 防御布局
     layout: {
       autoRepair: true,
       ammoDistribution: 'balanced',
       targetPriority: ['spitter', 'biter', 'worm']
     },
     
     // 雷达系统
     radar: {
       coverage: number,    // 覆盖范围
       scanInterval: 30,    // 扫描间隔
       alertSystem: true    // 警报系统
     }
   }
   ```

6. **物流设施管理**
   - 存储设施：箱子、储罐部署
   - 传输设施：传送带、机械臂配置
   - 物流网络：物品流向可视化
   - 瓶颈检测：自动识别物流瓶颈

7. **设施操作界面**
   ```
   单个设施管理卡片：
   ┌─────────────────────────────────┐
   │ 蒸汽发电机组                    │
   │ 数量: 5  总发电: 4.5MW          │
   │ ●●●●● 5/5 运行中               │
   │ 燃料: 煤炭 (剩余: 2:30)         │
   ├─────────────────────────────────┤
   │ [暂停全部] [添加] [升级]        │
   │ [详细管理] → 跳转详情页         │
   └─────────────────────────────────┘
   ```

8. **批量操作功能**
   - 同类设施批量控制
   - 一键补充燃料/弹药
   - 批量升级
   - 紧急停机

9. **设施建造系统**
   - 从库存消耗设施物品
   - 选择部署位置（简化的位置系统）
   - 自动连接电网/物流网
   - 建造队列管理

10. **维护与升级**
    - 设施健康度监控
    - 自动维修系统
    - 效率模块安装
    - 设施升级路径

## 7. 实现状态（2024年1月更新）

### 7.1 已完成功能 ✅

#### 核心系统
- **物流驱动生产系统**：完整实现，传送带和机械臂决定实际产能
- **实时效率计算**：动态计算并显示生产效率和瓶颈
- **库存管理**：物流设备消耗和返还机制
- **数据持久化**：自动保存和存档管理

#### 用户界面
- **物品管理**：分类展示、详情查看、状态指示
- **设施物流配置**：直观的配置界面，实时反馈
- **设施总览**：集中管理所有生产设施
- **生产链分析**：可视化生产依赖和瓶颈
- **批量操作**：支持批量配置物流设备

#### 性能优化
- **智能缓存**：避免重复计算
- **防抖机制**：减少频繁更新
- **React优化**：使用memo和hooks优化渲染

### 7.2 待实现功能 ⏳

#### 高优先级
- **科技研究系统**：研究新技术解锁高级设施
- **电力系统**：电力生产、传输和消耗
- **模块系统**：生产力、效能、速度模块

#### 中优先级
- **物流网络可视化**：图形化显示物流连接
- **生产统计**：历史数据和趋势图表
- **成就系统**：游戏目标和奖励

#### 低优先级
- **多语言支持**：国际化
- **PWA支持**：离线游戏
- **云存档**：跨设备同步

### 7.3 版本历史

#### v2.0.0 (2024-01)
- 实现完整的物流驱动生产系统
- 添加生产链分析功能
- 实现数据持久化和自动保存
- 添加批量操作功能
- 优化性能和用户体验

#### v1.0.0 (2024-01)
- 初始版本发布
- 基础物品管理系统
- 简单的制作队列

### 7.4 技术债务与改进方向

#### 已识别的技术债务
1. **设施数据**：目前使用硬编码数据，需要从游戏文件动态加载
2. **配方复杂度**：简化了某些复杂配方的处理
3. **类型定义**：部分类型使用any，需要更严格的类型
4. **测试覆盖**：缺少单元测试和集成测试
5. **错误边界**：需要添加React错误边界处理异常

#### 系统设计改进点
1. **传送带计算模型**
   - 当前：简单的数量×速度计算
   - 问题：未考虑实际布局（串联/并联/汇流）
   - 改进：添加拓扑感知的计算模型

2. **存储系统优化**
   - 当前：固定容量模式
   - 问题：不支持灵活的混合存储配置
   - 改进：支持多级存储和智能分配

3. **自动优化算法**
   - 当前：基于规则的简单优化
   - 问题：未考虑全局最优和成本效益
   - 改进：实现基于约束的优化算法

4. **用户体验提升**
   - 物流配置过于繁琐，需要更多一键操作
   - 缺少物流网络的可视化
   - 升级流程需要更智能的引导

### 7.5 游戏机制说明

#### 核心计算公式
```
实际产能 = MIN(基础产能, 输入物流能力, 输出物流能力)
物流能力 = MIN(传送带容量, 机械臂容量)
效率 = 实际产能 / 基础产能
```

#### 物流配置策略
1. **瓶颈识别**：系统自动识别是输入还是输出瓶颈
2. **优化建议**：提供多种方案（增加设备/升级设备/混合配置）
3. **成本考虑**：平衡效率提升和资源投入

#### 库存管理机制
1. **存储容量**：由配置的存储箱决定
2. **生产控制**：库存满时自动停产
3. **升级处理**：智能处理被替换的低级物品
