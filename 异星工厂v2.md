# 异星工厂手机版 PRD - 更新版本

## 1. 产品概述

### 1.1 产品定位

基于经典PC游戏《Factorio》设计的移动端工厂自动化管理游戏，采用以物品为中心的简化界面设计，支持多设备类型生产和完全自动化的资源管理系统。

### 1.2 核心特色

- **以物品为中心**的工厂管理界面
- **多设备类型**支持同一物品的不同生产方式
- **完全自动化**的资源管理（设备自动获取燃料和原料）
- **简化界面**专注核心数据和操作
- **本地存储**支持完全离线游戏体验

### 1.3 目标用户

- **核心用户**：25-44岁策略游戏爱好者
- **移动用户**：偏好简洁界面的手机游戏玩家
- **Factorio粉丝**：熟悉原版游戏机制的玩家

## 2. 功能需求规格

### 2.1 物品分类系统

#### 2.1.1 七大分类体系

```
物品分类结构：
├── 原材料 (Materials) 🛠️
│   ├── 基础矿物：铁矿石、铜矿石、煤炭、石头
│   ├── 流体资源：原油、水
│   └── 特性：可开采，部分支持手动获取
│
├── 中间产品 (Intermediate) ⚙️
│   ├── 金属制品：铁板、铜板、钢板、石砖
│   ├── 机械组件：铁齿轮、铜线、电路板、高级电路
│   └── 化工产品：塑料、硫酸等
│
├── 科学包 (Science) 🧪
│   ├── 6种颜色：红、绿、蓝、黑、紫、黄
│   ├── 用途：科技研发和解锁
│   └── 特性：制作复杂，需要多种材料
│
├── 生产设备 (Production) 🏭
│   ├── 开采设备：热力采掘机、电力采掘机
│   ├── 冶炼设备：石质熔炉、钢质熔炉、电炉
│   └── 装配设备：装配机1-3型、化工厂
│
├── 物流设备 (Logistics) 📦
│   ├── 传送系统：传送带、地下传送带、分流器
│   ├── 搬运设备：机械臂、快速机械臂
│   └── 存储设备：箱子、储液罐
│
├── 军事装备 (Military) ⚔️
│   ├── 武器系统：手枪、冲锋枪、火箭筒
│   ├── 弹药系统：弹夹、爆炸弹夹
│   └── 防护设备：轻型护甲、重型护甲
│
└── 电力设备 (Power) ⚡
    ├── 发电设备：蒸汽机、太阳能板、核反应堆
    ├── 传输设备：小型电线杆、大型电线杆
    └── 储存设备：蓄电池
```

#### 2.1.2 分类功能要求

- **Tab切换**：横向滚动标签栏，支持7个分类
- **图标识别**：每个分类有独特的图标和颜色
- **状态指示**：显示该分类物品的生产状态
- **快速定位**：点击分类快速跳转到对应物品

### 2.2 物品网格界面

#### 2.2.1 网格布局设计

```
网格布局规范：
├── 基础布局：4列 × N行
├── 卡片尺寸：80×100px
├── 间距设置：3px物品间距，12px行间距
├── 滚动区域：垂直滚动，支持惯性滚动
└── 响应式：自适应不同屏幕宽度
```

#### 2.2.2 物品卡片设计

```
物品卡片结构：
┌─────────────────┐
│  [999+]         │ ← 数量徽章（右上角）
│                 │
│   [彩色图标]     │ ← 物品图标（中央）
│                 │
│   物品名称       │ ← 名称（底部）
│   245个         │ ← 库存数量
└─────────────────┘
```

#### 2.2.3 视觉设计规范

- **图标颜色**：每类物品有独特的背景色系
- **数量徽章**：蓝色圆形，显示拥有数量
- **状态指示**：生产中、停产、缺料等状态用不同颜色边框
- **交互反馈**：点击时卡片阴影加深，提供视觉反馈

### 2.3 简化物品详情系统

#### 2.3.1 详情页面结构

```
简化详情页面布局：
┌─────────────────────────────────┐
│ [图标] 物品名称          [×关闭] │
├─────────────────────────────────┤
│ 📊 核心数据区域                  │
│ 库存: 245    净增长: +12.5/秒   │
│ 产量: +15.0/秒  消耗: -2.5/秒   │
├─────────────────────────────────┤
│ 🔨 手动操作区域 (条件显示)       │
│ [手动开采] [手动制作]           │
├─────────────────────────────────┤
│ 🏭 生产设施列表                  │
│ 热力采掘机  3台  +8.4/秒 [-][+] │
│ 电力采掘机  2台  +10.0/秒 [-][+]│
└─────────────────────────────────┘
```

#### 2.3.2 核心数据区域

**数据项定义：**

- **库存数量**：当前拥有的物品总数
- **净增长量**：每秒实际增长量（产量-消耗量）
- **每秒产量**：所有生产设备的产量总和
- **每秒消耗**：作为其他物品原料的消耗速度

**计算公式：**

```javascript
每秒产量 = Σ(设备基础速度 × 设备等级 × 设备效率 × 工作状态)
每秒消耗 = Σ(消耗该物品的设备产量 × 配方消耗比例)
净增长量 = 每秒产量 - 每秒消耗
```

#### 2.3.3 手动操作区域

**显示条件：**

- **手动开采**：原材料类物品且可开采时显示
- **手动制作**：有制作配方的物品显示

**操作功能：**

- 点击后添加任务到制作队列
- 显示预计完成时间
- 检查材料充足性

#### 2.3.4 生产设施列表

**设施卡片设计：**

```
设施卡片结构：
┌─────────────────────────────────┐
│ 设施名称                        │
│ X台 | 产能: +XX.X/秒             │
│ ●●○ 2/3 运行中     [-] 3 [+]    │
└─────────────────────────────────┘
```

**信息展示：**

- **设施名称**：设备类型名称
- **数量统计**：该类设施的总数量
- **总产能**：该类设施的总产量
- **运行状态**：用彩色圆点显示每台设备状态（绿=运行，红=停止）
- **数量控制**：增减按钮直接调整设施数量

### 2.4 设备自动化管理系统

#### 2.4.1 设备类型定义

```javascript
设备类型数据结构：
{
  设备ID: {
    name: "设备名称",
    category: "设备分类", // mining/smelting/assembly
    baseSpeed: 基础产量速度,
    powerType: "能源类型", // fuel/electric
    powerConsumption: 电力消耗, // kW
    fuelType: "燃料类型", // coal/wood/oil
    cost: { 建造成本材料 },
    canProduce: [可生产物品列表],
    efficiency: 基础效率系数
  }
}
```

#### 2.4.2 设备实例管理

```javascript
设备实例数据结构：
{
  物品ID: {
    设备类型: [
      {
        id: 唯一标识符,
        level: 设备等级,
        efficiency: 效率系数,
        working: 工作状态布尔值,
        // 燃料设备专有属性
        fuel: 当前燃料量,
        maxFuel: 最大燃料容量,
        // 电力设备专有属性
        powerConnected: 电力连接状态
      }
    ]
  }
}
```

#### 2.4.3 完全自动化机制

**燃料自动管理：**

```
燃料自动补充流程：
1. 每100ms检查设备燃料水平
2. 燃料 < 50%最大容量时触发补充
3. 自动从库存中消耗煤炭
4. 按比例转换为设备燃料
5. 库存煤炭不足时设备自动停机
6. 补充煤炭后设备自动重启
```

**原料自动消耗：**

```
原料自动消耗流程：
1. 检查物品制作配方
2. 验证库存原料是否充足
3. 按生产速度比例消耗原料
4. 同步产出目标物品
5. 原料不足时自动停止生产
6. 补充原料后自动恢复生产
```

### 2.5 制作队列系统

#### 2.5.1 队列界面设计

```
制作队列布局：
┌─────────────────────────────────┐
│ 🔧 制作队列 (3/10)               │
│ ┌─────────────────────────────┐ │
│ │ 开采 铁矿石    制作中...     │ │
│ │ ████████░░ 75% 1.2秒剩余    │ │
│ │                        [×] │ │
│ └─────────────────────────────┘ │
│ ┌─────────────────────────────┐ │
│ │ 制作 铁齿轮    等待中       │ │
│ │                        [×] │ │
│ └─────────────────────────────┘ │
└─────────────────────────────────┘
```

#### 2.5.2 队列功能规范

- **容量限制**：最多10个任务并发
- **进度显示**：当前执行任务显示进度条和剩余时间
- **状态标识**：制作中、等待中、材料不足等状态
- **取消功能**：任意任务可单独取消
- **自动排队**：手动操作自动添加到队列末尾

### 2.6 本地存储系统

#### 2.6.1 存储架构设计

```
本地存储架构：
├── 主存储：SQLite数据库
│   ├── game_state表：游戏核心状态
│   ├── save_slots表：多存档支持
│   └── user_settings表：用户配置
│
├── 配置存储：SharedPreferences/AsyncStorage
│   ├── 界面设置
│   ├── 游戏偏好
│   └── 最后选择的存档
│
└── 缓存存储：内存缓存
    ├── 当前游戏状态
    ├── 计算结果缓存
    └── 界面状态缓存
```

#### 2.6.2 数据持久化策略

```
自动保存机制：
├── 频率控制：每30秒自动保存
├── 事件触发：重要操作后立即保存
├── 应用生命周期：
│   ├── 进入后台：立即保存
│   ├── 应用退出：强制保存
│   └── 崩溃恢复：定期备份
└── 数据完整性：
    ├── 保存前验证数据有效性
    ├── 保存后校验数据完整性
    └── 损坏时自动恢复机制
```

#### 2.6.3 多存档系统

```
存档管理功能：
├── 存档槽位：支持最多5个存档
├── 存档信息：
│   ├── 存档名称（用户自定义）
│   ├── 游戏进度（等级、时间）
│   ├── 创建时间和最后修改时间
│   └── 存档预览图（可选）
├── 存档操作：
│   ├── 创建新存档
│   ├── 加载指定存档
│   ├── 删除存档
│   ├── 重命名存档
│   └── 导出/导入存档文件
└── 存档保护：
    ├── 删除前二次确认
    ├── 重要存档锁定保护
    └── 意外删除恢复机制
```

## 3. 用户界面设计规范

### 3.1 整体视觉系统

#### 3.1.1 主界面布局

```
主界面结构：
┌─────────────────────────────────┐ ← 状态栏 (64px)
│ 异星工厂  12:34  💰100 💎10 [⏸️] │
├─────────────────────────────────┤ ← 制作队列 (条件显示)
│ 🔧 制作队列 (2/10) [展开/收起]   │
│ [队列任务列表...]               │
├─────────────────────────────────┤ ← 分类标签 (48px)
│ [原材料][中间产品][科学包]...   │
├─────────────────────────────────┤ ← 主要内容区域
│                                 │
│        4×N 物品网格             │
│                                 │
│                                 │
└─────────────────────────────────┘
```

#### 3.1.2 响应式设计规范

```
屏幕适配规范：
├── 最小宽度：320px (iPhone SE)
├── 最大宽度：480px (大屏手机)
├── 安全区域：适配刘海屏和圆角
├── 触摸目标：最小44×44px
└── 字体缩放：支持系统字体大小设置
```

### 3.2 色彩设计系统

#### 3.2.1 主色调定义

```
颜色规范：
├── 主色调：
│   ├── 主色：#2563EB (蓝色) - 主要按钮、链接
│   ├── 成功：#10B981 (绿色) - 成功状态、运行中
│   ├── 警告：#F59E0B (橙色) - 警告状态、燃料相关
│   ├── 错误：#EF4444 (红色) - 错误状态、停止状态
│   └── 中性：#6B7280 (灰色) - 文本、边框
│
├── 分类色彩：
│   ├── 原材料：#F97316 (橙色系)
│   ├── 中间产品：#3B82F6 (蓝色系)
│   ├── 科学包：#8B5CF6 (紫色系)
│   ├── 生产设备：#EAB308 (黄色系)
│   ├── 物流设备：#22C55E (绿色系)
│   ├── 军事装备：#EF4444 (红色系)
│   └── 电力设备：#06B6D4 (青色系)
│
└── 状态色彩：
    ├── 生产中：#10B981 (绿色)
    ├── 停止中：#EF4444 (红色)
    ├── 缺料中：#F59E0B (橙色)
    └── 维护中：#6B7280 (灰色)
```

#### 3.2.2 物品图标色彩

```
物品图标颜色映射：
├── 矿物类：棕色到橙色系
├── 金属类：银色到灰色系
├── 机械类：黄色到金色系
├── 电子类：绿色到蓝色系
├── 化工类：蓝色到紫色系
├── 科技类：紫色到粉色系
└── 军事类：红色到深红系
```

### 3.3 字体和排版规范

#### 3.3.1 字体层级系统

```
字体大小规范：
├── 标题文字：18px, 字重700 (页面标题)
├── 副标题：16px, 字重600 (区域标题)
├── 正文文字：14px, 字重400 (主要文本)
├── 辅助文字：12px, 字重400 (辅助信息)
├── 小号文字：10px, 字重400 (状态标签)
└── 数字文字：14px, 字重600 (数值显示)
```

#### 3.3.2 排版间距规范

```
间距系统：
├── 基础间距：4px (最小间距单位)
├── 组件内间距：8px (按钮内边距)
├── 相关元素间距：12px (相关内容间距)
├── 段落间距：16px (段落之间间距)
├── 区域间距：24px (不同区域间距)
└── 页面间距：32px (页面边距)
```

### 3.4 交互设计规范

#### 3.4.1 触摸交互标准

```
交互行为定义：
├── 点击 (Tap)：
│   ├── 物品卡片：打开物品详情
│   ├── 设施按钮：调整设施数量
│   ├── 分类标签：切换物品分类
│   └── 功能按钮：执行对应功能
│
├── 长按 (Long Press)：
│   ├── 物品卡片：快速操作菜单
│   ├── 设施项目：设施详细信息
│   └── 队列任务：任务管理选项
│
└── 滑动 (Swipe)：
    ├── 水平滑动：切换分类标签
    ├── 垂直滑动：滚动物品列表
    └── 制作队列：滑动删除任务
```

#### 3.4.2 动画和过渡效果

```
动画规范：
├── 页面切换：300ms ease-in-out
├── 弹窗出现：200ms ease-out
├── 按钮点击：100ms ease-in
├── 数值变化：150ms ease-out
├── 进度条：实时更新，无动画
└── 状态切换：200ms ease-in-out
```

### 3.5 组件设计规范

#### 3.5.1 按钮组件规范

```
按钮类型定义：
├── 主要按钮：
│   ├── 背景：#2563EB
│   ├── 文字：#FFFFFF
│   ├── 高度：44px
│   ├── 圆角：8px
│   └── 用途：主要操作
│
├── 次要按钮：
│   ├── 背景：透明
│   ├── 边框：1px #2563EB
│   ├── 文字：#2563EB
│   ├── 高度：44px
│   └── 用途：次要操作
│
├── 危险按钮：
│   ├── 背景：#EF4444
│   ├── 文字：#FFFFFF
│   ├── 高度：44px
│   └── 用途：删除等危险操作
│
└── 图标按钮：
    ├── 尺寸：44×44px
    ├── 背景：透明或浅色
    ├── 图标：24×24px
    └── 用途：工具栏操作
```

#### 3.5.2 卡片组件规范

```
卡片设计规范：
├── 背景色：#FFFFFF
├── 边框：1px #E5E7EB
├── 圆角：8px
├── 阴影：0 1px 3px rgba(0,0,0,0.1)
├── 内边距：12px
├── 悬停效果：阴影加深
└── 点击效果：轻微缩放
```

#### 3.5.3 进度条组件规范

```
进度条设计：
├── 细进度条：
│   ├── 高度：4px
│   ├── 背景：#E5E7EB
│   ├── 前景：根据类型选择
│   └── 圆角：2px
│
└── 粗进度条：
    ├── 高度：8px
    ├── 背景：#E5E7EB
    ├── 前景：根据类型选择
    └── 圆角：4px
```

## 4. 技术实现规范

### 4.1 技术架构选型

#### 4.1.1 前端技术栈

```
推荐技术方案：
├── 主框架：React Native
│   ├── 优势：跨平台、生态成熟、性能优秀
│   ├── 版本：React Native 0.72+
│   └── 语言：TypeScript
│
├── 状态管理：Redux Toolkit
│   ├── 全局状态：游戏核心数据
│   ├── 本地状态：React useState
│   └── 持久化：Redux Persist
│
├── 导航：React Navigation 6
│   ├── 页面导航：Stack Navigator
│   ├── 标签导航：Tab Navigator
│   └── 弹窗导航：Modal Navigator
│
└── UI组件：
    ├── 基础组件：React Native内置
    ├── 图标库：React Native Vector Icons
    └── 动画库：React Native Reanimated
```

#### 4.1.2 数据存储技术

```
存储技术选型：
├── 游戏数据：SQLite
│   ├── 库：react-native-sqlite-storage
│   ├── 优势：结构化存储、查询性能好
│   └── 用途：游戏状态、存档、统计数据
│
├── 配置数据：AsyncStorage
│   ├── 库：@react-native-async-storage/async-storage
│   ├── 优势：简单易用、性能好
│   └── 用途：用户设置、偏好配置
│
├── 缓存数据：内存
│   ├── 实现：JavaScript对象
│   ├── 优势：访问速度最快
│   └── 用途：当前游戏状态、计算结果
│
└── 临时数据：文件系统
    ├── 库：react-native-fs
    ├── 优势：大容量、可导出
    └── 用途：存档备份、日志文件
```

### 4.2 数据结构设计

#### 4.2.1 游戏状态数据结构

```typescript
interface GameState {
  // 玩家信息
  player: {
    id: string;
    level: number;
    experience: number;
    playtime: number;
    currencies: {
      gold: number;
      crystals: number;
    };
  };
  
  // 资源库存
  resources: {
    [itemId: string]: number;
  };
  
  // 设备实例
  equipment: {
    [itemId: string]: {
      [equipmentType: string]: EquipmentInstance[];
    };
  };
  
  // 科技研发
  research: {
    [techId: string]: {
      unlocked: boolean;
      researched: boolean;
      progress: number;
    };
  };
  
  // 制作队列
  craftingQueue: CraftingTask[];
  
  // 游戏设置
  settings: {
    autoSave: boolean;
    soundEnabled: boolean;
    vibrationEnabled: boolean;
    selectedCategory: string;
  };
  
  // 元数据
  metadata: {
    version: string;
    lastSaved: number;
    totalPlaytime: number;
  };
}
```

#### 4.2.2 设备实例数据结构

```typescript
interface EquipmentInstance {
  id: string;
  type: string;
  level: number;
  efficiency: number;
  working: boolean;
  
  // 燃料设备专有
  fuel?: number;
  maxFuel?: number;
  fuelType?: string;
  
  // 电力设备专有
  powerConnected?: boolean;
  powerConsumption?: number;
  
  // 模块插槽
  modules?: {
    [slotIndex: number]: ModuleInstance;
  };
  
  // 状态信息
  lastMaintenance?: number;
  totalRuntime?: number;
  totalProduction?: number;
}
```

#### 4.2.3 制作任务数据结构

```typescript
interface CraftingTask {
  id: string;
  type: 'mining' | 'crafting';
  itemId: string;
  quantity: number;
  progress: number;
  totalTime: number;
  
  // 制作任务专有
  recipeId?: string;
  materialsConsumed?: boolean;
  
  // 开采任务专有
  miningMethod?: 'manual' | 'automatic';
  
  // 状态信息
  createdAt: number;
  startedAt?: number;
  estimatedCompletion?: number;
}
```

### 4.3 性能优化策略

#### 4.3.1 渲染性能优化

```
渲染优化措施：
├── 虚拟化滚动：
│   ├── 使用FlatList代替ScrollView
│   ├── 设置合理的初始渲染数量
│   └── 实现windowSize优化
│
├── 图片优化：
│   ├── 使用适当的图片格式和尺寸
│   ├── 实现图片懒加载
│   └── 缓存频繁使用的图片
│
├── 组件优化：
│   ├── 使用React.memo避免无用渲染
│   ├── 使用useMemo缓存计算结果
│   └── 使用useCallback避免函数重新创建
│
└── 状态管理优化：
    ├── 避免过度的状态更新
    ├── 使用批量更新减少渲染次数
    └── 合理拆分状态避免全局更新
```

#### 4.3.2 内存管理优化

```
内存优化策略：
├── 数据结构优化：
│   ├── 使用合适的数据类型
│   ├── 避免循环引用
│   └── 及时清理不用的数据
│
├── 缓存策略：
│   ├── 设置合理的缓存大小限制
│   ├── 实现LRU缓存淘汰策略
│   └── 定期清理过期缓存
│
├── 对象池：
│   ├── 重用频繁创建的对象
│   ├── 预分配常用对象
│   └── 减少垃圾回收压力
│
└── 监控工具：
    ├── 集成内存使用监控
    ├── 设置内存泄漏警告
    ├── 定期内存使用报告
    └── 性能瓶颈自动检测
```

#### 4.3.3 游戏循环优化

```
游戏循环性能优化：
├── 频率控制：
│   ├── 主循环：100ms (10fps)
│   ├── UI更新：16.67ms (60fps)
│   ├── 数据保存：30s自动保存
│   └── 统计计算：1s更新一次
│
├── 计算优化：
│   ├── 增量计算：只计算变化的部分
│   ├── 批量处理：合并多个小计算
│   ├── 异步计算：复杂计算放入后台
│   └── 缓存结果：缓存重复计算结果
│
├── 更新策略：
│   ├── 脏标记：标记需要更新的数据
│   ├── 优先级：重要数据优先计算
│   ├── 分帧处理：大任务分多帧完成
│   └── 暂停机制：后台时暂停非必要计算
│
└── 资源管理：
    ├── 对象复用：复用临时计算对象
    ├── 延迟初始化：按需创建计算对象
    ├── 自动垃圾回收：定期清理无用对象
    └── 资源预加载：提前加载常用资源
```

### 4.4 数据持久化实现

#### 4.4.1 SQLite数据库设计

```sql
-- 游戏存档表
CREATE TABLE save_files (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    game_data TEXT NOT NULL, -- JSON格式的游戏数据
    preview_image BLOB,      -- 存档预览图
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL,
    version TEXT NOT NULL,
    is_active BOOLEAN DEFAULT FALSE
);

-- 用户设置表
CREATE TABLE user_settings (
    key TEXT PRIMARY KEY,
    value TEXT NOT NULL,
    type TEXT NOT NULL -- 'string', 'number', 'boolean', 'json'
);

-- 游戏统计表
CREATE TABLE game_statistics (
    save_id INTEGER,
    stat_name TEXT,
    stat_value REAL,
    recorded_at INTEGER,
    FOREIGN KEY (save_id) REFERENCES save_files(id)
);

-- 成就记录表
CREATE TABLE achievements (
    save_id INTEGER,
    achievement_id TEXT,
    unlocked_at INTEGER,
    progress REAL DEFAULT 0,
    FOREIGN KEY (save_id) REFERENCES save_files(id)
);
```

#### 4.4.2 数据序列化策略

```typescript
// 数据压缩和序列化
class GameDataSerializer {
  // 序列化游戏状态
  static serialize(gameState: GameState): string {
    // 1. 移除冗余数据
    const cleanedState = this.removeRedundantData(gameState);
    
    // 2. 压缩数据结构
    const compressedState = this.compressData(cleanedState);
    
    // 3. JSON序列化
    const serialized = JSON.stringify(compressedState);
    
    // 4. 可选的进一步压缩
    return this.gzipCompress(serialized);
  }
  
  // 反序列化游戏状态
  static deserialize(data: string): GameState {
    // 1. 解压缩
    const decompressed = this.gzipDecompress(data);
    
    // 2. JSON解析
    const parsed = JSON.parse(decompressed);
    
    // 3. 数据解压缩
    const expanded = this.expandData(parsed);
    
    // 4. 数据验证和修复
    return this.validateAndRepair(expanded);
  }
  
  // 版本迁移
  static migrate(data: any, fromVersion: string, toVersion: string): GameState {
    const migrations = this.getMigrations(fromVersion, toVersion);
    return migrations.reduce((state, migration) => migration(state), data);
  }
}
```

#### 4.4.3 自动保存机制

```typescript
class AutoSaveManager {
  private saveTimer: NodeJS.Timeout | null = null;
  private pendingSave = false;
  private lastSaveTime = 0;
  
  // 启动自动保存
  startAutoSave(interval: number = 30000) {
    this.saveTimer = setInterval(() => {
      this.performAutoSave();
    }, interval);
  }
  
  // 执行自动保存
  private async performAutoSave() {
    if (this.pendingSave) return;
    
    this.pendingSave = true;
    try {
      const gameState = store.getState().game;
      const hasChanges = this.hasSignificantChanges(gameState);
      
      if (hasChanges) {
        await this.saveGameState(gameState);
        this.lastSaveTime = Date.now();
      }
    } catch (error) {
      console.error('自动保存失败:', error);
    } finally {
      this.pendingSave = false;
    }
  }
  
  // 强制保存
  async forceSave(): Promise<void> {
    if (this.saveTimer) {
      clearInterval(this.saveTimer);
    }
    await this.performAutoSave();
    this.startAutoSave();
  }
  
  // 检查是否有重要变化
  private hasSignificantChanges(gameState: GameState): boolean {
    // 检查资源变化
    // 检查设备状态变化
    // 检查研发进度变化
    // 返回是否需要保存
    return true;
  }
}
```

## 5. 用户体验设计

### 5.1 新手引导系统

#### 5.1.1 引导流程设计

```
新手引导步骤：
├── 第一步：界面介绍 (30秒)
│   ├── 展示主界面各区域功能
│   ├── 说明分类标签的作用
│   └── 介绍物品网格布局
│
├── 第二步：基础操作 (60秒)
│   ├── 点击物品查看详情
│   ├── 尝试手动开采铁矿石
│   └── 观察库存数量变化
│
├── 第三步：自动化入门 (90秒)
│   ├── 建造第一台热力采掘机
│   ├── 观察自动开采过程
│   └── 理解燃料自动补充机制
│
├── 第四步：生产链建立 (120秒)
│   ├── 建造熔炉冶炼铁板
│   ├── 制作第一个铁齿轮
│   └── 完成第一个科技包制作
│
└── 第五步：科技研发 (60秒)
    ├── 使用科技包解锁新技术
    ├── 建造装配机实现自动化
    └── 设置第一条完整生产线
```

#### 5.1.2 引导机制设计

```typescript
interface TutorialStep {
  id: string;
  title: string;
  description: string;
  targetElement?: string;
  highlightArea?: 'circle' | 'rectangle';
  action?: 'tap' | 'drag' | 'wait';
  condition?: () => boolean;
  onComplete?: () => void;
  skippable: boolean;
}

class TutorialManager {
  private currentStep = 0;
  private steps: TutorialStep[] = [];
  private overlay: React.Component | null = null;
  
  // 开始引导
  startTutorial(tutorialId: string) {
    this.steps = this.loadTutorialSteps(tutorialId);
    this.showNextStep();
  }
  
  // 显示下一步
  showNextStep() {
    if (this.currentStep >= this.steps.length) {
      this.completeTutorial();
      return;
    }
    
    const step = this.steps[this.currentStep];
    this.showStepOverlay(step);
  }
  
  // 检查步骤完成条件
  checkStepCompletion() {
    const step = this.steps[this.currentStep];
    if (step.condition && step.condition()) {
      this.currentStep++;
      this.showNextStep();
    }
  }
}
```

### 5.2 游戏平衡性设计

#### 5.2.1 进度曲线设计

```
游戏进度平衡：
├── 早期阶段 (0-30分钟)
│   ├── 手动操作为主
│   ├── 资源获取容易
│   ├── 制作时间短
│   └── 快速正反馈
│
├── 发展阶段 (30分钟-2小时)
│   ├── 自动化入门
│   ├── 设备建造成本合理
│   ├── 生产链逐步复杂
│   └── 科技解锁有序
│
├── 扩张阶段 (2-8小时)
│   ├── 大规模自动化
│   ├── 资源需求增加
│   ├── 效率优化挑战
│   └── 高级科技解锁
│
└── 优化阶段 (8小时以上)
    ├── 完全自动化
    ├── 效率极限挑战
    ├── 复杂生产链
    └── 无限扩展可能
```

#### 5.2.2 经济平衡设计

```
资源平衡公式：
├── 基础资源比例：
│   ├── 铁矿石：基准 (1.0)
│   ├── 铜矿石：0.8倍需求
│   ├── 煤炭：0.6倍需求 (但多用途)
│   └── 石头：0.4倍需求
│
├── 设备成本曲线：
│   ├── 基础设备：线性增长
│   ├── 高级设备：指数增长
│   ├── 升级成本：等级^1.5
│   └── 维护成本：固定比例
│
├── 生产效率曲线：
│   ├── 手动效率：1.0倍
│   ├── 基础自动化：5-10倍
│   ├── 高级自动化：50-100倍
│   └── 极限效率：1000倍+
│
└── 科技解锁成本：
    ├── 红色科技：10-50包
    ├── 绿色科技：20-100包
    ├── 蓝色科技：50-200包
    └── 高级科技：100-500包
```

### 5.3 错误处理和用户反馈

#### 5.3.1 错误处理策略

```
错误处理机制：
├── 数据错误：
│   ├── 自动数据验证
│   ├── 损坏数据修复
│   ├── 备份数据恢复
│   └── 默认值填充
│
├── 操作错误：
│   ├── 输入验证
│   ├── 操作确认
│   ├── 撤销功能
│   └── 错误提示
│
├── 系统错误：
│   ├── 异常捕获
│   ├── 错误日志
│   ├── 崩溃恢复
│   └── 降级处理
│
└── 网络错误：
    ├── 离线模式
    ├── 重试机制
    ├── 缓存策略
    └── 同步恢复
```

#### 5.3.2 用户反馈系统

```
反馈机制设计：
├── 即时反馈：
│   ├── 按钮点击效果
│   ├── 数值变化动画
│   ├── 状态指示灯
│   └── 进度条更新
│
├── 操作确认：
│   ├── 成功操作提示
│   ├── 失败原因说明
│   ├── 警告信息展示
│   └── 建议操作指导
│
├── 进度反馈：
│   ├── 制作进度显示
│   ├── 研发进度追踪
│   ├── 建造进度提示
│   └── 升级进度展示
│
└── 系统通知：
    ├── 重要事件通知
    ├── 错误警告提示
    ├── 成就解锁通知
    └── 更新提醒信息
```

## 6. 测试验收标准

### 6.1 功能测试要求

#### 6.1.1 核心功能测试

```
功能测试清单：
├── 物品管理：
│   ✓ 物品分类正确显示
│   ✓ 物品网格布局正确
│   ✓ 物品详情数据准确
│   ✓ 库存数量实时更新
│
├── 设备管理：
│   ✓ 设备建造功能正常
│   ✓ 设备数量调整正确
│   ✓ 设备状态显示准确
│   ✓ 自动化生产正常
│
├── 制作系统：
│   ✓ 手动制作功能正常
│   ✓ 制作队列管理正确
│   ✓ 进度显示准确
│   ✓ 材料消耗正确
│
├── 自动化系统：
│   ✓ 燃料自动补充正常
│   ✓ 原料自动消耗正确
│   ✓ 设备自动启停正常
│   ✓ 生产计算准确
│
└── 数据持久化：
    ✓ 自动保存功能正常
    ✓ 手动保存功能正常
    ✓ 数据加载正确
    ✓ 多存档管理正常
```

#### 6.1.2 边界条件测试

```
边界测试场景：
├── 资源极限：
│   ✓ 库存为0时的处理
│   ✓ 库存达到上限的处理
│   ✓ 负数资源的防护
│   ✓ 超大数值的处理
│
├── 设备极限：
│   ✓ 设备数量为0的处理
│   ✓ 设备数量达到上限
│   ✓ 所有设备停机的情况
│   ✓ 设备效率为0的处理
│
├── 时间极限：
│   ✓ 游戏时间超长的处理
│   ✓ 制作时间为0的处理
│   ✓ 系统时间异常的处理
│   ✓ 离线时间过长的处理
│
└── 数据极限：
    ✓ 存档大小超限的处理
    ✓ 存档数量超限的处理
    ✓ 数据损坏的恢复
    ✓ 版本不兼容的处理
```

### 6.2 性能测试标准

#### 6.2.1 响应时间要求

```
性能基准：
├── 界面响应：
│   ✓ 点击响应 < 100ms
│   ✓ 页面切换 < 300ms
│   ✓ 数据更新 < 200ms
│   ✓ 动画流畅 60fps
│
├── 数据处理：
│   ✓ 游戏循环 < 10ms
│   ✓ 保存操作 < 1000ms
│   ✓ 加载操作 < 3000ms
│   ✓ 计算更新 < 50ms
│
├── 内存使用：
│   ✓ 基础内存 < 100MB
│   ✓ 峰值内存 < 200MB
│   ✓ 内存增长 < 1MB/小时
│   ✓ 内存释放及时
│
└── 电池消耗：
    ✓ 待机模式 < 1%/小时
    ✓ 活跃模式 < 10%/小时
    ✓ 后台模式 < 2%/小时
    ✓ 充电时无过热
```

#### 6.2.2 压力测试要求

```
压力测试场景：
├── 数据量压力：
│   ✓ 1000+ 设备实例
│   ✓ 10000+ 物品库存
│   ✓ 100+ 制作队列任务
│   ✓ 长时间连续运行
│
├── 操作频率压力：
│   ✓ 快速点击测试
│   ✓ 大量并发操作
│   ✓ 频繁保存加载
│   ✓ 快速切换界面
│
├── 资源压力：
│   ✓ 低内存设备测试
│   ✓ 存储空间不足测试
│   ✓ 电量不足测试
│   ✓ 网络不稳定测试
│
└── 时间压力：
    ✓ 7×24小时稳定运行
    ✓ 频繁前后台切换
    ✓ 长期数据累积
    ✓ 系统资源竞争
```

### 6.3 兼容性测试要求

#### 6.3.1 设备兼容性

```
设备测试矩阵：
├── iOS设备：
│   ✓ iPhone SE (4.7")
│   ✓ iPhone 12 (6.1")
│   ✓ iPhone 12 Pro Max (6.7")
│   ✓ iPad (10.2")
│
├── Android设备：
│   ✓ 小屏设备 (5.0"-5.5")
│   ✓ 标准设备 (5.5"-6.0")
│   ✓ 大屏设备 (6.0"-6.7")
│   ✓ 平板设备 (7"+)
│
├── 系统版本：
│   ✓ iOS 12+ (最低支持)
│   ✓ iOS 15+ (推荐)
│   ✓ Android 7+ (最低支持)
│   ✓ Android 10+ (推荐)
│
└── 硬件配置：
    ✓ 2GB RAM (最低)
    ✓ 4GB RAM (推荐)
    ✓ 32GB 存储 (最低)
    ✓ 64GB 存储 (推荐)
```

## 7. 发布和维护计划

### 7.1 版本发布计划

#### 7.1.1 MVP版本 (v1.0)

```
v1.0 功能清单：
├── 核心功能 (必须):
│   ✓ 7大分类物品管理
│   ✓ 简化物品详情页面
│   ✓ 基础设备管理
│   ✓ 手动和自动生产
│   ✓ 本地存储系统
│
├── 基础功能 (必须):
│   ✓ 制作队列系统
│   ✓ 科技研发系统
│   ✓ 新手引导系统
│   ✓ 基础设置功能
│
├── 优化功能 (可选):
│   ✓ 性能优化
│   ✓ 动画效果
│   ✓ 音效支持
│   ✓ 多语言支持
│
└── 发布目标:
    ✓ iOS App Store
    ✓ Google Play Store
    ✓ 基础用户获取
    ✓ 用户反馈收集
```

#### 7.1.2 迭代版本计划

```
版本迭代路线图：
├── v1.1 (发布后1个月):
│   ├── Bug修复和性能优化
│   ├── 用户反馈功能改进
│   ├── 新增成就系统
│   └── 社交分享功能
│
├── v1.2 (发布后3个月):
│   ├── 新增高级设备类型
│   ├── 扩展科技树内容
│   ├── 新增统计分析功能
│   └── 改进UI界面
│
├── v1.3 (发布后6个月):
│   ├── 新增军事装备系统
│   ├── 扩展化工生产链
│   ├── 新增挑战模式
│   └── 云存档支持
│
└── v2.0 (发布后1年):
    ├── 多人合作模式
    ├── 工厂设计分享
    ├── 高级自动化系统
    └── 3D可视化界面
```

### 7.2 运营维护计划

#### 7.2.1 日常维护任务

```
维护任务清单：
├── 每日任务:
│   ✓ 监控服务器状态
│   ✓ 检查崩溃报告
│   ✓ 回复用户反馈
│   ✓ 监控关键指标
│
├── 每周任务:
│   ✓ 分析用户数据
│   ✓ 更新内容计划
│   ✓ Bug修复优先级
│   ✓ 竞品分析调研
│
├── 每月任务:
│   ✓ 版本发布计划
│   ✓ 功能需求评估
│   ✓ 技术债务清理
│   ✓ 团队绩效评估
│
└── 每季度任务:
    ✓ 产品路线图调整
    ✓ 技术架构升级
    ✓ 市场策略调整
    ✓ 团队能力建设
```

#### 7.2.2 用户支持体系

```
用户支持计划：
├── 技术支持:
│   ├── 常见问题解答
│   ├── 在线客服系统
│   ├── 用户手册文档
│   └── 视频教程制作
│
├── 社区运营:
│   ├── 官方社区建设
│   ├── 用户活动策划
│   ├── 内容创作激励
│   └── 意见反馈收集
│
├── 问题处理:
│   ├── Bug报告处理流程
│   ├── 功能需求收集
│   ├── 用户投诉处理
│   └── 数据恢复服务
│
└── 持续改进:
    ├── 用户体验优化
    ├── 功能迭代升级
    ├── 性能持续优化
    └── 新技术应用探索
```

-----

## 附录

### A. 术语表

- **物品 (Item)**: 游戏中的所有可管理对象
- **设备 (Equipment)**: 用于生产物品的建筑
- **设施 (Facility)**: 设备的同义词，在界面中使用
- **配方 (Recipe)**: 物品的制作方法和材料需求
- **科技包 (Science Pack)**: 用于研发科技的特殊物品
- **净增长 (Net Growth)**: 物品的产量减去消耗量

### B. 数据字典

详细的数据结构定义和字段说明

### C. API接口文档

内部数据接口和方法定义

### D. 设计资源

UI设计稿、图标资源、动画规范等

-----

**文档信息**

- 版本：v2.0
- 更新日期：2025年7月18日
- 文档状态：已更新 - 简化物品详情页面，添加本地存储支持
- 下一次更新：根据开发进度和用户反馈进行调整​​​​​​​​​​​​​​​​